<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadoras de RRHH - Nómina, Carga Prestacional y Liquidación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos generales para el cuerpo de la página */
        body {
            font-family: 'Inter', sans-serif; /* Usando Inter como se sugiere */
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinear arriba para que no se centre verticalmente si es muy alto */
            min-height: 100vh;
            padding: 20px;
        }
        /* Contenedor principal de la aplicación */
        .app-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px; /* Bordes más redondeados */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 1200px; /* Ancho máximo para el contenedor */
            width: 100%;
            box-sizing: border-box; /* Incluir padding en el ancho */
        }
        /* Estilos para los botones de las pestañas */
        .tab-button {
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            background-color: #e0e7ff; /* Azul claro */
            color: #4f46e5; /* Azul oscuro */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            background-color: #6366f1; /* Azul más oscuro */
            color: #fff;
            border-bottom: 3px solid #4f46e5;
        }
        .tab-button:hover:not(.active) {
            background-color: #c7d2fe; /* Azul aún más claro al pasar el mouse */
        }
        /* Contenido de las pestañas */
        .tab-content {
            display: none;
            padding: 20px 0;
            border-top: 1px solid #e0e7ff;
        }
        .tab-content.active {
            display: block;
        }
        /* Estilos para los inputs y selects */
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
            border: 1px solid #d1d5db; /* Gris claro */
            border-radius: 6px;
            padding: 10px 12px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }
        input[type="radio"] {
            margin-right: 8px;
        }
        .input-group.disabled-input {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Estilos para la tabla de resultados de carga prestacional */
        #cargosTable th, #cargosTable td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        #cargosTable th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        #cargosTable tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        #cargosTable tbody tr:hover {
            background-color: #f3f4f6;
        }
        .currency {
            text-align: right;
            font-family: 'Inter', sans-serif; /* Asegurar fuente para números */
        }

        /* Estilos para botones de acción en tabla */
        .detail-row-btn, .edit-row-btn, .delete-row-btn {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 5px;
            transition: background-color 0.2s ease;
        }
        .detail-row-btn {
            background-color: #60a5fa; /* Azul */
            color: white;
        }
        .detail-row-btn:hover {
            background-color: #3b82f6;
        }
        .edit-row-btn {
            background-color: #fcd34d; /* Amarillo */
            color: #78350f;
        }
        .edit-row-btn:hover {
            background-color: #fbbf24;
        }
        .delete-row-btn {
            background-color: #ef4444; /* Rojo */
            color: white;
        }
        .delete-row-btn:hover {
            background-color: #dc2626;
        }

        /* Estilos para el modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #6b7280;
        }
        .close-button:hover {
            color: #374151;
        }
        #detailTable th, #detailTable td {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }
        #detailTable th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        #detailTable tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        /* Estilos para la impresión */
        @media print {
            @page {
                size: Letter; /* Tamaño de papel carta */
                margin: 0.5in; /* Márgenes de 0.5 pulgadas */
            }
            body {
                zoom: 0.80; /* Reducir un poco el tamaño para que quepa mejor */
                -webkit-print-color-adjust: exact !important; /* Forzar impresión de colores de fondo en Chrome/Safari */
                color-adjust: exact !important; /* Estándar para forzar impresión de colores */
                font-size: 10pt; /* Ajustar el tamaño de fuente general para impresión */
            }
            .no-print {
                display: none !important; /* Ocultar elementos no deseados en impresión */
            }
            
            /* Oculta todas las secciones por defecto en impresión, excepto las que se activen explícitamente */
            section {
                display: none !important; 
            }

            table, th, td {
                border: 1px solid #ccc !important; /* Asegurar bordes visibles en la tabla al imprimir */
            }
            th {
                background-color: #f2f2f2 !important; /* Fondo claro para encabezados de tabla en impresión */
            }
            /* Restablecer colores de fondo para impresión si el navegador lo permite */
            .domingo-row, .festivo-row, .domingo-festivo-row {
                background-color: inherit !important; 
            }

            /* PRINT MODE FOR NOMINA (Detailed Results) */
            body.print-mode-nomina #nominaSection {
                display: block !important; /* Muestra solo esta sección */
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                animation: none;
                transform: none;
                opacity: 1;
            }

            /* PRINT MODE FOR RECIBO (Receipt) */
            body.print-mode-recibo #reciboNominaSeccion {
                display: block !important; /* Muestra solo esta sección */
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                animation: none;
                transform: none;
                opacity: 1;
            }

            /* PRINT MODE FOR CARGA PRESTACIONAL */
            body.print-mode-carga #cargaPrestacionalSection {
                display: block !important;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                animation: none;
                transform: none;
                opacity: 1;
            }

            /* PRINT MODE FOR LIQUIDACION */
            body.print-mode-liquidacion #liquidacionSection {
                display: block !important;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                animation: none;
                transform: none;
                opacity: 1;
            }

            /* PRINT MODE FOR LIQUIDACION RECEIPT */
            body.print-mode-liquidacion-receipt #liquidacionReceiptSectionWrapper {
                display: block !important;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                animation: none;
                transform: none;
                opacity: 1;
            }
        }

        /* Estilos para responsividad en móviles */
        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column; /* Apilar elementos en móviles */
            }
            .mobile-stack > * {
                margin-bottom: 0.5rem; /* Espacio entre elementos apilados */
            }
            .time-input, #fechaInicio, #fechaFin {
                font-size: 0.875rem; /* Reducir tamaño de fuente en inputs de tiempo y fecha en móviles */
            }
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .receipt-container {
                margin: 0 10px; /* Margen en móviles */
            }
        }

        /* Styles for the custom message modal */
        .message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than other modals */
        }
        .message-modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        .message-modal-content h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .message-modal-content p {
            font-size: 1rem;
            color: #555;
            margin-bottom: 20px;
        }
        .message-modal-content button {
            background-color: #6366f1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .message-modal-content button:hover {
            background-color: #4f46e5;
        }
        .message-modal-content.success h3 {
            color: #10B981; /* Green */
        }
        .message-modal-content.error h3 {
            color: #EF4444; /* Red */
        }

        /* Estilos mejorados para el recibo POS */
        .receipt-container {
            max-width: 380px;
            margin: 0 auto;
            background-color: #fff;
            border: 1px solid #eee;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            animation: fade-in-slide-up 0.8s ease-out forwards;
        }

        .receipt-header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
            margin-bottom: 15px;
        }

        .receipt-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .receipt-body {
            margin: 15px 0;
        }

        .receipt-section {
            margin-bottom: 15px;
        }

        .receipt-subtitle {
            font-weight: bold;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 5px;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.9rem;
        }

        .receipt-total {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px dashed #ccc;
            margin-top: 10px;
            font-weight: bold;
        }

        .receipt-net {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-top: 2px solid #000;
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .receipt-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            text-align: center;
        }

        .receipt-signature {
            margin: 20px 0 15px;
        }

        .signature-line {
            border-top: 1px solid #000;
            width: 60%;
            margin: 0 auto 5px;
        }

        .signature-label {
            font-size: 0.8rem;
        }

        .receipt-thanks {
            font-style: italic;
            color: #666;
        }

        @keyframes fade-in-slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-100 min-h-screen font-sans">
    <div class="app-container">
        <header class="text-center mb-8 no-print">
            <h1 class="text-4xl font-bold text-indigo-700 mb-3">Calculadoras de RRHH - Colombia</h1>
            <p class="text-gray-600 text-lg">Herramientas para Nómina, Carga Prestacional y Liquidación de Contrato.</p>
        </header>

        <nav class="flex justify-center mb-8 border-b border-blue-200 no-print">
            <button class="tab-button active" onclick="showTab('nomina')">Nómina</button>
            <button class="tab-button" onclick="showTab('carga-prestacional')">Carga Prestacional</button>
            <button class="tab-button" onclick="showTab('liquidacion')">Liquidación</button>
        </nav>

        <!-- Sección de Calculadora de Nómina -->
        <section id="nomina" class="tab-content active">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Calculadora de Nómina</h2>
            <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-8">
                <h3 class="text-xl font-medium text-gray-700 mb-3">Configuración Básica del Empleado</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="nombreEmpresa" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Empresa</label>
                        <input type="text" id="nombreEmpresa" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" placeholder="Nombre de la Empresa">
                    </div>
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Trabajador</label>
                        <input type="text" id="nombre" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" placeholder="Nombre completo">
                    </div>
                    <div>
                        <label for="cedula" class="block text-sm font-medium text-gray-700 mb-1">Número de Identificación</label>
                        <input type="text" id="cedula" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" placeholder="Número de cédula">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="salario" class="block text-sm font-medium text-gray-700 mb-1">Salario Mensual (COP)</label>
                        <input type="number" id="salario" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="1423500" min="0">
                    </div>
                    <div>
                        <label for="transporte" class="block text-sm font-medium text-gray-700 mb-1">Auxilio Transporte (COP Mensual)</label>
                        <input type="number" id="transporte" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="162000" min="0">
                    </div>
                    <div>
                        <label for="jornada" class="block text-sm font-medium text-gray-700 mb-1">Jornada Laboral (horas/semana)</label>
                        <select id="jornada" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <option value="47">47 horas (Ley 2101 - 2024)</option>
                            <option value="46" selected>46 horas (Ley 2101 - 2025)</option>
                            <option value="44">44 horas (Ley 2101 - 2026)</option>
                            <option value="42">42 horas (Ley 2101 - Final)</option>
                            <option value="48">48 horas (Anterior)</option>
                            <option value="40">40 horas (Especial)</option>
                            <option value="36">36 horas (Especial)</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 mb-6">
                    <div>
                        <label for="reembolso" class="block text-sm font-medium text-gray-700 mb-1">Otros Ingresos / Reembolsos (COP)</label>
                        <input type="number" id="reembolso" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="descuento" class="block text-sm font-medium text-gray-700 mb-1">Otros Descuentos (COP)</label>
                        <input type="number" id="descuento" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="tipoTurno" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Turno</label>
                        <select id="tipoTurno" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <option value="regular">Regular (L-S, D descanso)</option>
                            <option value="4x3">4x3 (4 días trabajo, 3 descanso)</option>
                            <option value="5x2">5x2 (5 días trabajo, 2 descanso)</option>
                            <option value="4x3_rotativo">4x3 Rotativo (día/noche)</option>
                        </select>
                    </div>
                </div>
                
                <h3 class="text-xl font-medium text-gray-700 mb-3 mt-4">Configuración de Horarios por Defecto</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="horaEntrada" class="block text-sm font-medium text-gray-700 mb-1">Hora de Entrada</label>
                        <input type="time" id="horaEntrada" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm time-input">
                    </div>
                    <div>
                        <label for="horaSalida" class="block text-sm font-medium text-gray-700 mb-1">Hora de Salida</label>
                        <input type="time" id="horaSalida" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm time-input">
                    </div>
                    <div>
                        <label for="horasDescansoPeriodo" class="block text-sm font-medium text-gray-700 mb-1">Descanso Diario (horas)</label>
                        <input type="number" id="horasDescansoPeriodo" class="w-24 p-2.5 border border-gray-300 rounded-lg shadow-sm descanso-input" value="1" min="0" max="4" step="0.25">
                    </div>
                    <div id="horasPorDiaTurnoContainer" style="display: none;">
                        <label for="horasPorDiaTurno" class="block text-sm font-medium text-gray-700 mb-1">Horas Netas por Día de Turno</label>
                        <input type="number" id="horasPorDiaTurno" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="10" min="0" step="0.5">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rango para Prellenar</label>
                        <div class="flex gap-2">
                            <input type="date" id="fechaInicio" class="flex-1 p-2.5 border border-gray-300 rounded-xl shadow-sm">
                            <input type="date" id="fechaFin" class="flex-1 p-2.5 border border-gray-300 rounded-xl shadow-sm">
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-4 no-print">
                    <button id="prellenar" class="bg-indigo-600 text-white py-2.5 px-5 rounded-lg hover:bg-indigo-700 shadow-md">
                        <i class="fas fa-magic mr-2"></i>Prellenar Horarios
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Registro Detallado de Horarios</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sem.</th>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Día</th>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Entrada</th>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Salida</th>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Aux. Trans.</th>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Festivo</th>
                                <th class="py-3 px-3 sm:px-4 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="horarios" class="divide-y divide-gray-200">
                            <!-- Filas de horarios se añadirán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-start sm:justify-end gap-3 no-print">
                    <button id="agregarDia" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 shadow-md">
                        <i class="fas fa-plus mr-2"></i>Agregar Día Manualmente
                    </button>
                    <button id="calcular" class="bg-green-600 text-white py-2.5 px-6 rounded-lg hover:bg-green-700 shadow-md font-semibold">
                        <i class="fas fa-calculator mr-2"></i>Calcular Nómina del Periodo
                    </button>
                </div>
            </div>

            <section id="resultadosSeccion" class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-8" style="display: none;">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Resultados del Cálculo de Nómina</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3">Resumen de Horas del Periodo</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between py-1.5 border-b"><span>Días Trabajados en Periodo:</span><span id="diasTrabajados" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Días Festivos Trabajados:</span><span id="diasFestivos" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>H. Ordinarias Diurnas:</span><span id="horasOrdinarias" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>H. con Recargo Nocturno (en jornada):</span><span id="horasNocturnas" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>H. Extra Diurnas:</span><span id="horasExtraDiurnas" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>H. Extra Nocturnas:</span><span id="horasExtraNocturnas" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>H. Ord. Dominical/Festiva Diurna:</span><span id="horasDominicalesDiurnas" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>H. Ord. Dominical/Festiva Nocturna:</span><span id="horasDominicalesNocturnas" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>H. Extra Dominical/Festiva Diurna:</span><span id="horasExtraDominicalesDiurnas" class="font-medium">0</span></div>
                            <div class="flex justify-between py-1.5"><span>H. Extra Dominical/Festiva Nocturna:</span><span id="horasExtraDominicalesNocturnas" class="font-medium">0</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3">Total Devengado</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between py-1.5 border-b"><span>Salario Base (días trabajados):</span><span id="salarioBaseCalculado" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor H. Ordinarias Diurnas:</span><span id="valorOrdinarias" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor Recargo Nocturno:</span><span id="valorRecargoNocturno" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor H. Extra Diurnas:</span><span id="valorExtraDiurnas" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor H. Extra Nocturnas:</span><span id="valorExtraNocturnas" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor H. Ord. Dom./Fest. Diurna:</span><span id="valorDominicalesDiurnas" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor H. Ord. Dom./Fest. Nocturna:</span><span id="valorDominicalesNocturnas" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor H. Extra Dom./Fest. Diurna:</span><span id="valorExtraDominicalesDiurnas" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Valor H. Extra Dom./Fest. Nocturna:</span><span id="valorExtraDominicalesNocturnas" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Auxilio Transporte:</span><span id="valorTransporte" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Otros Ingresos / Reembolsos:</span><span id="valorReembolso" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 font-bold text-lg text-indigo-700"><span>Total Devengado:</span><span id="totalDevengado">$0</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mt-8">
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3">Deducciones</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between py-1.5 border-b"><span>Salud (4% s/IBC):</span><span id="deduccionSalud" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Pensión (4% s/IBC):</span><span id="deduccionPension" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Otros Descuentos:</span><span id="valorDescuento" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 font-bold text-lg text-red-600"><span>Total Deducciones:</span><span id="totalDeducciones">$0</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3">Neto a Pagar</h3>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div class="flex justify-between items-center py-1.5 font-bold text-2xl text-green-700">
                                <span>Total Neto del Periodo:</span>
                                <span id="netoPagar">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-10 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <button id="imprimir" class="bg-gray-700 text-white py-3 px-8 rounded-lg hover:bg-gray-800 shadow-md flex items-center text-lg">
                        <i class="fas fa-print mr-3"></i>Imprimir Nómina
                    </button>
                    <button id="guardarEnSheets" class="bg-purple-600 text-white py-3 px-8 rounded-lg hover:bg-purple-700 shadow-md flex items-center text-lg">
                        <i class="fas fa-save mr-3"></i>Guardar en Sheets
                    </button>
                    <button id="mostrarImprimirReciboBtn" class="bg-indigo-600 text-white py-3 px-8 rounded-lg hover:bg-indigo-700 shadow-md flex items-center text-lg">
                        <i class="fas fa-receipt mr-3"></i>Ver e Imprimir Recibo
                    </button>
                </div>
            </section>

            <section id="reciboNominaSeccion" class="bg-white rounded-xl shadow-xl p-6 sm:p-8" style="display: none;">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3 no-print">Recibo de Pago de Nómina</h2>
                <div class="receipt-container">
                    <div class="receipt-header">
                        <div class="receipt-title">RECIBO DE PAGO DE NÓMINA</div>
                        <p>Fecha de Emisión: <span id="receiptFechaEmision"></span></p>
                    </div>

                    <div class="receipt-body">
                        <div class="receipt-section">
                            <div class="receipt-item"><span>Trabajador:</span> <span id="receiptNombre"></span></div>
                            <div class="receipt-item"><span>Cédula:</span> <span id="receiptCedula"></span></div>
                            <div class="receipt-item"><span>Salario Mensual:</span> <span id="receiptSalarioMensual"></span></div>
                            <div class="receipt-item"><span>Periodo de Liquidación:</span> <span id="receiptPeriodoLiquidacion"></span></div>
                            <div class="receipt-item"><span>Días Trabajados:</span> <span id="receiptDiasTrabajados"></span></div>
                        </div>

                        <div class="receipt-section">
                            <div class="receipt-subtitle">DEVENGADO</div>
                            <div class="receipt-item"><span>Valor Días Trabajados:</span> <span id="receiptValorDiasTrabajados"></span></div>
                            <div class="receipt-item"><span>Auxilio de Transporte:</span> <span id="receiptAuxilioTransporte"></span></div>
                            <div class="receipt-item"><span>Otros Ingresos:</span> <span id="receiptOtrosIngresos"></span></div>
                            <div class="receipt-total"><span>TOTAL DEVENGADO:</span> <span id="receiptTotalDevengado"></span></div>
                        </div>

                        <div class="receipt-section">
                            <div class="receipt-subtitle">DEDUCCIONES</div>
                            <div class="receipt-item"><span>Salud (4%):</span> <span id="receiptDeduccionSalud"></span></div>
                            <div class="receipt-item"><span>Pensión (4%):</span> <span id="receiptDeduccionPension"></span></div>
                            <div class="receipt-item"><span>Otros Descuentos:</span> <span id="receiptOtrosDescuentos"></span></div>
                            <div class="receipt-total"><span>TOTAL DEDUCCIONES:</span> <span id="receiptTotalDeducciones"></span></div>
                        </div>

                        <div class="receipt-net">
                            <span>NETO A PAGAR:</span> <span id="receiptNetoPagar"></span>
                        </div>
                    </div>

                    <div class="receipt-footer">
                        <div class="receipt-signature">
                            <div class="signature-line"></div>
                            <div class="signature-label">Firma del Trabajador</div>
                        </div>
                        <p class="receipt-thanks">¡Gracias por tu trabajo!</p>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <button id="volverAResultadosBtn" class="bg-gray-500 text-white py-3 px-8 rounded-lg hover:bg-gray-600 shadow-md flex items-center text-lg">
                        <i class="fas fa-arrow-left mr-3"></i>Volver a Resultados
                    </button>
                    <button id="imprimirReciboFinalBtn" class="bg-indigo-600 text-white py-3 px-8 rounded-lg hover:bg-indigo-700 shadow-md flex items-center text-lg">
                        <i class="fas fa-print mr-3"></i>Imprimir Recibo
                    </button>
                </div>
            </section>
        </section>

        <!-- Sección de Calculadora de Carga Prestacional -->
        <section id="carga-prestacional" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Calculadora de Carga Prestacional</h2>
            <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-8">
                <h3 class="text-xl font-medium text-gray-700 mb-3">Datos del Cargo / Empleado</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="carga_inputCargoNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cargo</label>
                        <input type="text" id="carga_inputCargoNombre" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" placeholder="Ej: Vendedor, Gerente">
                    </div>
                    <div>
                        <label for="carga_inputNumEmpleados" class="block text-sm font-medium text-gray-700 mb-1">Número de Empleados en este Cargo</label>
                        <input type="number" id="carga_inputNumEmpleados" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="1" min="1">
                    </div>
                    <div>
                        <label for="carga_inputSalarioBase" class="block text-sm font-medium text-gray-700 mb-1">Salario Base Mensual (COP)</label>
                        <input type="number" id="carga_inputSalarioBase" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="1500000" min="0">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Salario Integral</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputSalarioIntegral" id="carga_inputSalarioIntegralSi" value="si" class="form-radio text-indigo-600">
                                <span class="ml-2 text-gray-700">Sí</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputSalarioIntegral" id="carga_inputSalarioIntegralNo" value="no" class="form-radio text-indigo-600" checked>
                                <span class="ml-2 text-gray-700">No</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="carga_inputBonosNoPrestacionales" class="block text-sm font-medium text-gray-700 mb-1">Bonos No Prestacionales (COP/mes)</label>
                        <input type="number" id="carga_inputBonosNoPrestacionales" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Auxilio de Transporte</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputAuxTransporte" id="carga_inputAuxTransporteSi" value="si" class="form-radio text-indigo-600" checked>
                                <span class="ml-2 text-gray-700">Sí</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputAuxTransporte" id="carga_inputAuxTransporteNo" value="no" class="form-radio text-indigo-600">
                                <span class="ml-2 text-gray-700">No</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="carga_inputValorDotacionEntrega" class="block text-sm font-medium text-gray-700 mb-1">Valor Dotación (por entrega)</label>
                        <input type="number" id="carga_inputValorDotacionEntrega" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="carga_inputTiempoTrabajoMeses" class="block text-sm font-medium text-gray-700 mb-1">Tiempo de Trabajo (meses/año)</label>
                        <input type="number" id="carga_inputTiempoTrabajoMeses" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="12" min="1" max="12">
                    </div>
                    <div>
                        <label for="carga_inputTipoContrato" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Contrato</label>
                        <select id="carga_inputTipoContrato" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <option value="indefinido">Indefinido</option>
                            <option value="fijo">Fijo</option>
                            <option value="obra">Obra o Labor</option>
                            <option value="aprendizaje">Aprendizaje</option>
                            <option value="servicio">Prestación de Servicios</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Es Pensionado</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputEsPensionado" id="carga_inputEsPensionadoSi" value="si" class="form-radio text-indigo-600">
                                <span class="ml-2 text-gray-700">Sí</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputEsPensionado" id="carga_inputEsPensionadoNo" value="no" class="form-radio text-indigo-600" checked>
                                <span class="ml-2 text-gray-700">No</span>
                            </label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Exención Parafiscales (Ley 1607/2012)</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputExencionParafiscales" id="carga_inputExencionParafiscalesSi" value="si" class="form-radio text-indigo-600">
                                <span class="ml-2 text-gray-700">Sí</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="carga_inputExencionParafiscales" id="carga_inputExencionParafiscalesNo" value="no" class="form-radio text-indigo-600" checked>
                                <span class="ml-2 text-gray-700">No</span>
                            </label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="carga_inputTipoRiesgoARL" class="block text-sm font-medium text-gray-700 mb-1">Clase de Riesgo ARL</label>
                        <select id="carga_inputTipoRiesgoARL" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <option value="1">Clase I (0.522%)</option>
                            <option value="2">Clase II (1.044%)</option>
                            <option value="3" selected>Clase III (2.436%)</option>
                            <option value="4">Clase IV (4.350%)</option>
                            <option value="5">Clase V (6.960%)</option>
                        </select>
                    </div>
                </div>
                <h3 class="text-xl font-medium text-gray-700 mb-3 mt-4">Configuración de Turnos (para horas estimadas)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="carga_tipoTurno" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Turno</label>
                        <select id="carga_tipoTurno" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <option value="regular">Regular (L-S, D descanso)</option>
                            <option value="4x3">4x3 (4 días trabajo, 3 descanso)</option>
                            <option value="5x2">5x2 (5 días trabajo, 2 descanso)</option>
                            <option value="4x3_rotativo">4x3 Rotativo (día/noche)</option>
                        </select>
                    </div>
                    <div id="carga_horasPorDiaTurnoContainer">
                        <label for="carga_horasPorDiaTurno" class="block text-sm font-medium text-gray-700 mb-1">Horas Netas por Día de Turno</label>
                        <input type="number" id="carga_horasPorDiaTurno" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="10" min="0" step="0.5">
                    </div>
                    <div id="carga_descansoRegularContainer">
                        <label for="carga_descansoRegular" class="block text-sm font-medium text-gray-700 mb-1">Día de Descanso Regular</label>
                        <select id="carga_descansoRegular" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <option value="domingo">Domingo</option>
                            <option value="sabado">Sábado</option>
                            <option value="lunes">Lunes</option>
                            <option value="martes">Martes</option>
                            <option value="miércoles">Miércoles</option>
                            <option value="jueves">Jueves</option>
                            <option value="viernes">Viernes</option>
                        </select>
                    </div>
                    <div>
                        <label for="carga_horaEntrada" class="block text-sm font-medium text-gray-700 mb-1">Hora de Entrada</label>
                        <input type="time" id="carga_horaEntrada" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="07:00">
                    </div>
                    <div>
                        <label for="carga_horaSalida" class="block text-sm font-medium text-gray-700 mb-1">Hora de Salida</label>
                        <input type="time" id="carga_horaSalida" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="16:00">
                    </div>
                    <div>
                        <label for="carga_horasDescansoDiario" class="block text-sm font-medium text-gray-700 mb-1">Descanso Diario (horas)</label>
                        <input type="number" id="carga_horasDescansoDiario" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="1" min="0" step="0.25">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3 no-print">
                    <button id="agregarCargoBtn" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 shadow-md">
                        <i class="fas fa-plus mr-2"></i>Agregar Cargo
                    </button>
                    <button id="limpiarFormCargaBtn" class="bg-gray-400 text-white py-2.5 px-5 rounded-lg hover:bg-gray-500 shadow-md">
                        <i class="fas fa-eraser mr-2"></i>Limpiar Formulario
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Resumen de Carga Prestacional</h2>
                <div class="overflow-x-auto mb-6">
                    <table id="cargosTable" class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead>
                            <tr>
                                <th>Cargo</th>
                                <th># Empleados</th>
                                <th>Salario Base (1 Emp)</th>
                                <th>Costo Directo Mensual (1 Emp)</th>
                                <th>Tipo Contrato</th>
                                <th>H. Ord. Diurnas Est. (1 Emp)</th>
                                <th>Recargos/Extras Est. (1 Emp)</th>
                                <th>Costo Total Mensual (1 Emp)</th>
                                <th>Costo Total Mensual (Cargo)</th>
                                <th>Costo Total Anual (Cargo)</th>
                                <th class="no-print">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filas de cargos se añadirán aquí -->
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 font-bold text-gray-800">
                                <td colspan="7" class="text-right">TOTAL MENSUAL GENERAL:</td>
                                <td id="totalMensualGeneral" class="currency">$0</td>
                                <td colspan="2" class="text-right">TOTAL ANUAL GENERAL:</td>
                                <td id="totalAnualGeneral" class="currency">$0</td>
                                <td class="no-print"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <button id="mostrarDetalleTotalBtn" class="bg-blue-600 text-white py-3 px-8 rounded-lg hover:bg-blue-700 shadow-md flex items-center text-lg">
                        <i class="fas fa-info-circle mr-3"></i>Ver Detalle Global
                    </button>
                    <button id="imprimirCargaBtn" class="bg-gray-700 text-white py-3 px-8 rounded-lg hover:bg-gray-800 shadow-md flex items-center text-lg">
                        <i class="fas fa-print mr-3"></i>Imprimir Resumen
                    </button>
                </div>
            </div>

            <!-- Modal de Detalle de Carga Prestacional -->
            <div id="detailModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-button" onclick="cerrarModal()">&times;</span>
                    <h3 id="modalTitle" class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Detalle de Carga Prestacional</h3>
                    <div class="overflow-x-auto">
                        <table id="detailTable" class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Valor Mensual (1 Emp)</th>
                                    <th>Total Cargo (Mensual)</th>
                                    <th>% sobre Salario Base</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Detalles se llenarán aquí -->
                            </tbody>
                        </table>
                    </div>
                    <p id="totalCargaPercentage" class="mt-4 text-lg font-semibold text-gray-700"></p>
                </div>
            </div>
        </section>

        <!-- Sección de Calculadora de Liquidación -->
        <section id="liquidacion" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Calculadora de Liquidación de Contrato</h2>
            <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-8">
                <h3 class="text-xl font-medium text-gray-700 mb-3">Datos del Empleado y Contrato</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="liq_nombreTrabajador" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Trabajador</label>
                        <input type="text" id="liq_nombreTrabajador" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" placeholder="Nombre completo">
                    </div>
                    <div>
                        <label for="liq_cedulaTrabajador" class="block text-sm font-medium text-gray-700 mb-1">Número de Identificación</label>
                        <input type="text" id="liq_cedulaTrabajador" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" placeholder="Número de cédula">
                    </div>
                    <div>
                        <label for="liq_salarioBase" class="block text-sm font-medium text-gray-700 mb-1">Salario Base Mensual (COP)</label>
                        <input type="number" id="liq_salarioBase" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="1423500" min="0">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Salario Integral</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="liq_esSalarioIntegral" id="liq_esSalarioIntegralSi" value="si" class="form-radio text-indigo-600">
                                <span class="ml-2 text-gray-700">Sí</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="liq_esSalarioIntegral" id="liq_esSalarioIntegralNo" value="no" class="form-radio text-indigo-600" checked>
                                <span class="ml-2 text-gray-700">No</span>
                            </label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Aplica Auxilio de Transporte</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="liq_aplicaAuxTransporte" id="liq_aplicaAuxTransporteSi" value="si" class="form-radio text-indigo-600" checked>
                                <span class="ml-2 text-gray-700">Sí</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="liq_aplicaAuxTransporte" id="liq_aplicaAuxTransporteNo" value="no" class="form-radio text-indigo-600">
                                <span class="ml-2 text-gray-700">No</span>
                            </label>
                        </div>
                    </div>
                </div>
                <h3 class="text-xl font-medium text-gray-700 mb-3 mt-4">Fechas y Días Adicionales</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="liq_fechaIngreso" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Ingreso</label>
                        <input type="date" id="liq_fechaIngreso" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="liq_fechaRetiro" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Retiro</label>
                        <input type="date" id="liq_fechaRetiro" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="liq_diasVacacionesPendientes" class="block text-sm font-medium text-gray-700 mb-1">Días de Vacaciones Pendientes (a compensar)</label>
                        <input type="number" id="liq_diasVacacionesPendientes" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="liq_diasIncapacidad" class="block text-sm font-medium text-gray-700 mb-1">Días de Incapacidad (no remunerada)</label>
                        <input type="number" id="liq_diasIncapacidad" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="liq_diasLicenciaNoRemunerada" class="block text-sm font-medium text-gray-700 mb-1">Días de Licencia No Remunerada</label>
                        <input type="number" id="liq_diasLicenciaNoRemunerada" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                </div>
                <h3 class="text-xl font-medium text-gray-700 mb-3 mt-4">Valores ya Pagados / Deducciones</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 mb-4">
                    <div>
                        <label for="liq_cesantiasConsignadas" class="block text-sm font-medium text-gray-700 mb-1">Cesantías Consignadas (último año)</label>
                        <input type="number" id="liq_cesantiasConsignadas" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="liq_interesesCesantiasPagados" class="block text-sm font-medium text-gray-700 mb-1">Intereses a Cesantías Pagados</label>
                        <input type="number" id="liq_interesesCesantiasPagados" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="liq_primasPagadas" class="block text-sm font-medium text-gray-700 mb-1">Primas de Servicio Pagadas (este semestre)</label>
                        <input type="number" id="liq_primasPagadas" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="liq_prestamosEmpresa" class="block text-sm font-medium text-gray-700 mb-1">Préstamos a la Empresa (a deducir)</label>
                        <input type="number" id="liq_prestamosEmpresa" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div>
                        <label for="liq_aportesVoluntariosPension" class="block text-sm font-medium text-gray-700 mb-1">Aportes Voluntarios a Pensión (a deducir)</label>
                        <input type="number" id="liq_aportesVoluntariosPension" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm" value="0" min="0">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Salario del mes de retiro ya pagado</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="liq_salarioYaPagado" id="liq_salarioYaPagadoCheck" class="form-checkbox text-indigo-600 rounded">
                                <span class="ml-2 text-gray-700">Sí, ya se pagó</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-center no-print">
                    <button id="calcularLiquidacionBtn" class="bg-green-600 text-white py-3 px-8 rounded-lg hover:bg-green-700 shadow-md font-semibold text-lg">
                        <i class="fas fa-calculator mr-2"></i>Calcular Liquidación
                    </button>
                </div>
            </div>

            <section id="liquidacionResultados" class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-8" style="display: none;">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">Resultados de Liquidación de Contrato</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3">Resumen de Días y Salario</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between py-1.5 border-b"><span>Días Totales Liquidados:</span><span id="liq_diasTotalesLiquidacion" class="font-medium">0 días</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Salario Pendiente (Mes de Retiro):</span><span id="liq_salarioPendiente" class="font-medium">$0</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3">Prestaciones Sociales</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between py-1.5 border-b"><span>Cesantías:</span><span id="liq_cesantias" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Intereses a Cesantías:</span><span id="liq_interesesCesantias" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5 border-b"><span>Prima de Servicios:</span><span id="liq_primaServicios" class="font-medium">$0</span></div>
                            <div class="flex justify-between py-1.5"><span>Vacaciones Compensadas:</span><span id="liq_vacacionesCompensadas" class="font-medium">$0</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mt-8">
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-3">Totales</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between py-1.5 font-bold text-lg text-indigo-700 border-b"><span>Total Devengado:</span><span id="liq_totalDevengado">$0</span></div>
                            <div class="flex justify-between py-1.5 font-bold text-lg text-red-600 border-b"><span>Total Deducciones:</span><span id="liq_totalDeducciones">$0</span></div>
                            <div class="flex justify-between items-center py-1.5 font-bold text-2xl text-green-700">
                                <span>Neto a Pagar:</span>
                                <span id="liq_netoAPagar">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-10 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <button id="mostrarImprimirReciboLiquidacionBtn" class="bg-indigo-600 text-white py-3 px-8 rounded-lg hover:bg-indigo-700 shadow-md flex items-center text-lg">
                        <i class="fas fa-receipt mr-3"></i>Ver e Imprimir Recibo
                    </button>
                    <button id="imprimirLiquidacionDetalladaBtn" class="bg-gray-700 text-white py-3 px-8 rounded-lg hover:bg-gray-800 shadow-md flex items-center text-lg">
                        <i class="fas fa-print mr-3"></i>Imprimir Liquidación Detallada
                    </button>
                </div>
            </section>

            <section id="liquidacionReceiptSectionWrapper" class="bg-white rounded-xl shadow-xl p-6 sm:p-8" style="display: none;">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3 no-print">Recibo de Liquidación de Contrato</h2>
                <div class="receipt-container">
                    <div class="receipt-header">
                        <div class="receipt-title">RECIBO DE LIQUIDACIÓN DE CONTRATO</div>
                        <p>Fecha de Emisión: <span id="liq_receiptFechaEmision"></span></p>
                    </div>

                    <div class="receipt-body">
                        <div class="receipt-section">
                            <div class="receipt-item"><span>Trabajador:</span> <span id="liq_receiptNombre"></span></div>
                            <div class="receipt-item"><span>Cédula:</span> <span id="liq_receiptCedula"></span></div>
                            <div class="receipt-item"><span>Salario Base:</span> <span id="liq_receiptSalarioBase"></span></div>
                            <div class="receipt-item"><span>Periodo Laborado:</span> <span id="liq_receiptPeriodoLaborado"></span></div>
                            <div class="receipt-item"><span>Días Totales Liquidados:</span> <span id="liq_receiptDiasTotales"></span></div>
                        </div>

                        <div class="receipt-section">
                            <div class="receipt-subtitle">DEVENGADO</div>
                            <div class="receipt-item"><span>Salario Pendiente:</span> <span id="liq_receiptSalarioPendiente"></span></div>
                            <div class="receipt-item"><span>Cesantías:</span> <span id="liq_receiptCesantias"></span></div>
                            <div class="receipt-item"><span>Intereses a Cesantías:</span> <span id="liq_receiptInteresesCesantias"></span></div>
                            <div class="receipt-item"><span>Prima de Servicios:</span> <span id="liq_receiptPrimaServicios"></span></div>
                            <div class="receipt-item"><span>Vacaciones Compensadas:</span> <span id="liq_receiptVacacionesCompensadas"></span></div>
                            <div class="receipt-total"><span>TOTAL DEVENGADO:</span> <span id="liq_receiptTotalDevengado"></span></div>
                        </div>

                        <div class="receipt-section">
                            <div class="receipt-subtitle">DEDUCCIONES</div>
                            <div class="receipt-item"><span>Préstamos a la Empresa:</span> <span id="liq_receiptPrestamosEmpresa"></span></div>
                            <div class="receipt-item"><span>Aportes Voluntarios Pensión:</span> <span id="liq_receiptAportesVoluntariosPension"></span></div>
                            <div class="receipt-total"><span>TOTAL DEDUCCIONES:</span> <span id="liq_receiptTotalDeducciones"></span></div>
                        </div>

                        <div class="receipt-net">
                            <span>NETO A PAGAR:</span> <span id="liq_netoAPagar2"></span>
                        </div>
                    </div>

                    <div class="receipt-footer">
                        <div class="receipt-signature">
                            <div class="signature-line"></div>
                            <div class="signature-label">Firma del Trabajador</div>
                        </div>
                        <p class="receipt-thanks">¡Gracias por tu trabajo!</p>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <button id="volverAResultadosLiquidacionBtn" class="bg-gray-500 text-white py-3 px-8 rounded-lg hover:bg-gray-600 shadow-md flex items-center text-lg">
                        <i class="fas fa-arrow-left mr-3"></i>Volver a Resultados
                    </button>
                    <button id="imprimirReciboLiquidacionFinalBtn" class="bg-indigo-600 text-white py-3 px-8 rounded-lg hover:bg-indigo-700 shadow-md flex items-center text-lg">
                        <i class="fas fa-print mr-3"></i>Imprimir Recibo
                    </button>
                </div>
            </section>
        </section>

        <footer class="mt-12 text-center text-gray-500 text-sm no-print">
            <p>&copy; <span id="currentYear"></span> Calculadoras de RRHH Colombia. Herramienta de referencia. Verifique siempre con la normativa vigente.</p>
        </footer>
    </div>

    <!-- Custom Message Modal -->
    <div id="messageModal" class="message-modal" style="display: none;">
        <div class="message-modal-content">
            <h3 id="messageModalTitle"></h3>
            <p id="messageModalText"></p>
            <button onclick="closeMessageModal()">Cerrar</button>
        </div>
    </div>

    <script>
    // --- Constantes Globales (Valores Actualizados 2025 - Ajustar si cambian) ---
    const SMMLV = 1423500; // Salario Mínimo Mensual Legal Vigente 2025 (Oficial)
    const AUX_TRANSPORTE_BASE = 200000; // Auxilio de Transporte 2025 (Oficial)
    const TOPE_IBC = 25 * SMMLV; // Tope máximo para IBC (25 SMMLV)

    // Tarifas de ARL por clase de riesgo
    const TARIFAS_ARL = {
        1: 0.00522, // Clase I
        2: 0.01044, // Clase II
        3: 0.02436, // Clase III
        4: 0.04350, // Clase IV
        5: 0.06960  // Clase V
    };

    // Porcentajes de aportes a Seguridad Social (Empleador)
    const SALUD_EMPLEADOR = 0.085; // 8.5%
    const PENSION_EMPLEADOR = 0.12; // 12%

    // Porcentajes de aportes Parafiscales (Empleador)
    const CAJA_COMPENSACION = 0.04; // 4%
    const SENA = 0.02; // 2%
    const ICBF = 0.03; // 3%

    // Factores de provisión para Prestaciones Sociales (mensualizados)
    const CESANTIAS_FACTOR = 0.0833; // 8.33% (1 mes de salario / 12 meses)
    const INTERESES_CESANTIAS_FACTOR = 0.01; // 1% anual sobre cesantías
    const PRIMA_FACTOR = 0.0833; // 8.33% (1 mes de salario / 12 meses)
    const VACACIONES_FACTOR = 0.0417; // 4.17% (0.5 meses de salario / 12 meses)

    // Constantes para cálculos de recargos (igual que en Nómina)
    const HORA_INICIO_NOCTURNA = 21; // 9 PM, inicio de jornada nocturna
    const HORA_FIN_NOCTURNA = 6;   // 6 AM, fin de jornada nocturna

    const RN_FACTOR = 0.35;      // Recargo Nocturno (35%)
    const HED_FACTOR = 0.25;     // Hora Extra Diurna (25%)
    const HEN_FACTOR = 0.75;     // Hora Extra Nocturnas (75%)
    const HODF_FACTOR = 0.75;    // Hora Ordinaria Dominical/Festiva (75% adicional, total 175%)

    // --- Funciones de Utilidad Comunes ---
    /**
     * Formatea un valor numérico como moneda colombiana (COP).
     * @param {number} value - El valor a formatear.
     * @returns {string} El valor formateado como COP.
     */
    function formatCurrency(value) {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0, // Sin decimales para pesos
            maximumFractionDigits: 0
        }).format(value);
    }

    /**
     * Formatea un valor numérico como porcentaje.
     * @param {number} value - El valor a formatear (ej. 0.15 para 15%).
     * @returns {string} El valor formateado como porcentaje.
     */
    function formatPercentage(value) {
        return new Intl.NumberFormat('es-CO', {
            style: 'percent',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    /**
     * Convierte una cadena de tiempo (HH:MM) a un número decimal de horas.
     * @param {string} timeStr - La cadena de tiempo.
     * @returns {number} Las horas en formato decimal.
     */
    function timeToDecimal(timeStr) { 
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        if (isNaN(hours) || isNaN(minutes)) return 0;
        return hours + (minutes / 60);
    }

    /**
     * Convierte una cadena de fecha a un objeto Date.
     * @param {string} dateString - La cadena de fecha en formatoYYYY-MM-DD.
     * @returns {Date|null} El objeto Date o null si es inválido.
     */
    function parseDateString(dateString) {
        if (!dateString) return null;
        // Ensure date is parsed in UTC to avoid timezone issues affecting date calculations
        const date = new Date(dateString + "T00:00:00"); 
        if (isNaN(date.getTime())) return null;
        return date;
    }

    /**
     * Calcula el número de semana para una fecha dada.
     * @param {Date} dateObj - El objeto Date.
     * @returns {number|string} El número de semana o una cadena vacía si la fecha es inválida.
     */
    function getWeekNumber(dateObj) {
        if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
        const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    /**
     * Calcula los días trabajados en un periodo, considerando un año de 360 días
     * y meses de 30 días para efectos de prestaciones (liquidaciones).
     * El día 31 de un mes no se contabiliza para estos efectos.
     * @param {Date} startDate - Fecha de inicio.
     * @param {Date} endDate - Fecha de fin.
     * @returns {number} El número de días entre las dos fechas (inclusive, asumiendo meses de 30 días).
     */
    function calculateDaysWorked360(startDate, endDate) {
        // Clonar las fechas para no modificar los originales
        let start = new Date(startDate);
        let end = new Date(endDate);

        // Ajustar el día de fin a 30 si es el día 31, para efectos de cálculo contable de 30 días por mes.
        // Esto aplica para liquidaciones (cesantías, prima, vacaciones).
        if (end.getDate() === 31) {
            end.setDate(30);
        }
        // Si la fecha de inicio es el 31, también se ajusta a 30.
        if (start.getDate() === 31) {
            start.setDate(30);
        }

        const yearDiff = end.getFullYear() - start.getFullYear();
        const monthDiff = end.getMonth() - start.getMonth();
        const dayDiff = end.getDate() - start.getDate();

        // Cálculo basado en un año de 360 días y meses de 30 días
        return (yearDiff * 360) + (monthDiff * 30) + dayDiff + 1; // +1 para que sea inclusivo
    }

    /**
     * Muestra un modal de mensaje personalizado.
     * @param {string} title - El título del mensaje.
     * @param {string} message - El contenido del mensaje.
     * @param {string} type - 'success' o 'error' para el estilo.
     */
    function showMessageModal(title, message, type) {
        const modal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('messageModalTitle');
        const modalText = document.getElementById('messageModalText');
        const modalContent = modal.querySelector('.message-modal-content');

        modalTitle.textContent = title;
        modalText.textContent = message;

        modalContent.classList.remove('success', 'error');
        if (type) {
            modalContent.classList.add(type);
        }
        modal.style.display = 'flex';
    }

    /**
     * Cierra el modal de mensaje personalizado.
     */
    function closeMessageModal() {
        const modal = document.getElementById('messageModal');
        modal.style.display = 'none';
    }


    // --- Lógica de Pestañas ---
    /**
     * Muestra el contenido de la pestaña seleccionada y actualiza los botones.
     * @param {string} tabId - El ID de la pestaña a mostrar ('nomina', 'carga-prestacional' o 'liquidacion').
     */
    function showTab(tabId) {
        // Ocultar todos los contenidos de las pestañas
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        // Desactivar todos los botones de las pestañas
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        // Mostrar el contenido de la pestaña seleccionada
        const selectedTabContent = document.getElementById(tabId);
        if (selectedTabContent) {
            selectedTabContent.classList.add('active');
        }

        // Activar el botón de la pestaña seleccionada
        const selectedTabButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
        if (selectedTabButton) {
            selectedTabButton.classList.add('active');
        }

        // Lógica específica de inicialización al cambiar de pestaña
        if (tabId === 'carga-prestacional') {
            applyFieldRestrictions();
            actualizarTotalesGenerales();
            toggleCargaHorasPorDiaTurnoInput();
        } else if (tabId === 'nomina') {
            setDefaultDates(); // Ensure default dates are set for nomina
            prellenarHorarios();
            calcularNomina();
            toggleHorasPorDiaTurnoInput();
        } else if (tabId === 'liquidacion') {
            applyLiquidacionFieldRestrictions();
            // Establecer fechas por defecto para liquidación al cargar la pestaña
            const today = new Date();
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            const toISODateString = (date) => {
                const tzoffset = (new Date()).getTimezoneOffset() * 60000;
                const localISOTime = (new Date(date - tzoffset)).toISOString().slice(0,10);
                return localISOTime;
            }
            if (document.getElementById('liq_fechaIngreso')) document.getElementById('liq_fechaIngreso').value = toISODateString(firstDayOfYear);
            if (document.getElementById('liq_fechaRetiro')) document.getElementById('liq_fechaRetiro').value = toISODateString(today);
        }
    }

    // --- Lógica de la Calculadora de Nómina ---
    const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    const festivosColombia2025 = [
        "2025-01-01", "2025-01-06", "2025-03-24", "2025-04-17", "2025-04-18",
        "2025-05-01", "2025-06-02", "2025-06-23", "2025-06-30", "2025-07-20",
        "2025-08-07", "2025-08-18", "2025-10-13", "2025-11-03", "2025-11-17",
        "2025-12-08", "2025-12-25"
    ];
    let registrosHorariosNomina = [];

    // Elementos del DOM (Inputs de configuración de nómina)
    const nombreEmpresaInput = document.getElementById('nombreEmpresa'); 
    const nombreInput = document.getElementById('nombre');
    const cedulaInput = document.getElementById('cedula');
    const salarioInput = document.getElementById('salario');
    const transporteInput = document.getElementById('transporte');
    const jornadaSelect = document.getElementById('jornada');
    const tipoTurnoSelect = document.getElementById('tipoTurno');
    const horasPorDiaTurnoInput = document.getElementById('horasPorDiaTurno');
    const horasPorDiaTurnoContainer = document.getElementById('horasPorDiaTurnoContainer');
    const reembolsoInput = document.getElementById('reembolso');
    const descuentoInput = document.getElementById('descuento');
    
    // Elementos del DOM (Configuración de horarios por defecto y prellenado de nómina)
    const horaEntradaInput = document.getElementById('horaEntrada');
    const horaSalidaInput = document.getElementById('horaSalida');
    const horasDescansoPeriodoInput = document.getElementById('horasDescansoPeriodo');
    const fechaInicioInput = document.getElementById('fechaInicio');
    const fechaFinInput = document.getElementById('fechaFin');
    
    // Elementos del DOM (Tabla de horarios y botones de acción de nómina)
    const horariosTableBody = document.getElementById('horarios');
    const agregarDiaBtn = document.getElementById('agregarDia');
    const prellenarBtn = document.getElementById('prellenar');
    const calcularBtn = document.getElementById('calcular');
    const imprimirBtn = document.getElementById('imprimir'); 
    const resultadosSeccion = document.getElementById('resultadosSeccion');
    
    // Elementos del DOM para la sección del recibo de nómina
    const reciboNominaSectionWrapper = document.getElementById('reciboNominaSeccion'); 
    const reciboNominaContainer = document.getElementById('reciboNominaSeccion'); // Usar el mismo ID para el contenedor
    const mostrarImprimirReciboBtn = document.getElementById('mostrarImprimirReciboBtn'); 
    const imprimirReciboFinalBtn = document.getElementById('imprimirReciboFinalBtn'); 
    const volverAResultadosBtn = document.getElementById('volverAResultadosBtn'); 
    const guardarEnSheetsBtn = document.getElementById('guardarEnSheets');

    // Referencias para los elementos del recibo de nómina
    const receiptFechaEmision = document.getElementById('receiptFechaEmision');
    const receiptNombre = document.getElementById('receiptNombre');
    const receiptCedula = document.getElementById('receiptCedula');
    const receiptSalarioMensual = document.getElementById('receiptSalarioMensual');
    const receiptPeriodoLiquidacion = document.getElementById('receiptPeriodoLiquidacion');
    const receiptDiasTrabajados = document.getElementById('receiptDiasTrabajados');
    const receiptValorDiasTrabajados = document.getElementById('receiptValorDiasTrabajados');
    const receiptAuxilioTransporte = document.getElementById('receiptAuxilioTransporte');
    const receiptOtrosIngresos = document.getElementById('receiptOtrosIngresos');
    const receiptTotalDevengado = document.getElementById('receiptTotalDevengado'); 
    const receiptDeduccionSalud = document.getElementById('receiptDeduccionSalud'); 
    const receiptDeduccionPension = document.getElementById('receiptDeduccionPension'); 
    const receiptOtrosDescuentos = document.getElementById('receiptOtrosDescuentos'); 
    const receiptTotalDeducciones = document.getElementById('receiptTotalDeducciones'); 
    const receiptNetoPagar = document.getElementById('receiptNetoPagar'); 
    
    /**
     * Establece las fechas por defecto para el prellenado de horarios.
     */
    function setDefaultDates() {
        const today = new Date();
        let firstDayOfPeriod = new Date(today.getFullYear(), today.getMonth(), 1);
        let lastDayOfPeriod = new Date(today.getFullYear(), today.getMonth(), 15);

        if (today.getDate() > 15) {
            firstDayOfPeriod = new Date(today.getFullYear(), today.getMonth(), 16);
            lastDayOfPeriod = new Date(today.getFullYear(), today.getMonth() + 1, 0); 
            
            if (firstDayOfPeriod.getMonth() !== today.getMonth()) { 
                 firstDayOfPeriod = new Date(today.getFullYear(), today.getMonth(), 16);
                 lastDayOfPeriod = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            }
        }

        const toISODateString = (date) => {
            const tzoffset = (new Date()).getTimezoneOffset() * 60000;
            const localISOTime = (new Date(date - tzoffset)).toISOString().slice(0,10);
            return localISOTime;
        }

        if (fechaInicioInput) fechaInicioInput.value = toISODateString(firstDayOfPeriod);
        if (fechaFinInput) fechaFinInput.value = toISODateString(lastDayOfPeriod);
        if (horaEntradaInput) horaEntradaInput.value = "07:00";
        if (horaSalidaInput) horaSalidaInput.value = "16:00";
    }
    
    /**
     * Actualiza el estilo de una fila de horario según si es domingo o festivo.
     * @param {object} registro - El objeto de registro de horario.
     */
    function actualizarEstiloFila(registro) {
        const row = registro.row;
        const fecha = parseDateString(registro.fechaInput.value);
        
        row.classList.remove('domingo-row', 'festivo-row', 'domingo-festivo-row');
        if (!fecha) return;

        const diaNum = fecha.getDay(); // 0 = Domingo
        const esFestivoMarcado = registro.festivoCheck.checked;
        
        if (diaNum === 0 && esFestivoMarcado) {
            row.classList.add('domingo-festivo-row');
        } else if (diaNum === 0) {
            row.classList.add('domingo-row');
        } else if (esFestivoMarcado) {
            row.classList.add('festivo-row');
        }
    }

    /**
     * Ordena las filas de la tabla de horarios por fecha.
     */
    function ordenarFilasPorFecha() {
        // Modificado: Seleccionar solo filas con el atributo data-id (que son las filas de datos)
        const filas = Array.from(horariosTableBody.querySelectorAll('tr[data-id]'));
        
        const originalPositions = new Map();
        filas.forEach((fila, index) => originalPositions.set(fila.id, index));

        filas.sort((a, b) => {
            const fechaA = parseDateString(a.querySelector('input[type="date"]').value);
            const fechaB = parseDateString(b.querySelector('input[type="date"]').value);
            if (!fechaA && !fechaB) return 0;
            if (!fechaA) return 1; 
            if (!fechaB) return -1;
            return fechaA - fechaB;
        });
        
        horariosTableBody.innerHTML = ''; 
        let semanaActual = -1;
        filas.forEach((fila, newIndex) => {
            const fechaDate = parseDateString(fila.querySelector('input[type="date"]').value);
            const numeroSemana = getWeekNumber(fechaDate);

            if (numeroSemana !== semanaActual) {
                semanaActual = numeroSemana;
                const weekRow = document.createElement('tr');
                weekRow.innerHTML = `<td colspan="8" class="py-2 px-3 sm:px-4 bg-indigo-100 text-indigo-800 font-semibold text-center text-sm rounded-md shadow-sm">Semana ${numeroSemana}</td>`;
                horariosTableBody.appendChild(weekRow);
            }
            
            horariosTableBody.appendChild(fila); 
            if (originalPositions.get(fila.id) !== newIndex) {
                fila.classList.remove('highlight'); 
                void fila.offsetWidth;
                fila.classList.add('highlight');
            }
        });
        
        setTimeout(() => {
            filas.forEach(fila => fila.classList.remove('highlight'));
        }, 1200);
    }

    /**
     * Agrega un nuevo día a la tabla de horarios de nómina.
     * @param {string} [fechaStr=null] - La fecha en formatoYYYY-MM-DD.
     * @param {object} [options={}] - Opciones para el día (esDescansoProgramado, esFestivoPredefinido, isManualAdd, entrada, salida).
     */
    function agregarDia(fechaStr = null, options = {}) {
        const { 
            esDescansoProgramado = false, 
            esFestivoPredefinido = false, 
            isManualAdd = false,
            entrada = horaEntradaInput ? horaEntradaInput.value : '', 
            salida = horaSalidaInput ? horaSalidaInput.value : ''   
        } = options;

        const id = `row-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const row = document.createElement('tr');
        row.id = id;
        row.setAttribute('data-id', id); // Asegurar que todas las filas de datos tengan data-id
        row.className = 'border-b border-gray-200 fila-movimiento hover:bg-gray-50';

        const semanaCell = document.createElement('td');
        semanaCell.className = 'py-2.5 px-3 sm:px-4 text-sm text-gray-700';
        const semanaSpan = document.createElement('span');
        semanaSpan.className = 'week-number';
        semanaCell.appendChild(semanaSpan);

        const fechaCell = document.createElement('td');
        fechaCell.className = 'py-2.5 px-3 sm:px-4';
        const fechaInput = document.createElement('input');
        fechaInput.type = 'date';
        fechaInput.className = 'p-2 border border-gray-300 rounded-md w-full text-sm';
        if (fechaStr) {
            fechaInput.value = fechaStr;
        } else if (isManualAdd) { 
            fechaInput.value = ''; 
        } else if (registrosHorariosNomina.length > 0) {
            const ultimaFechaStr = registrosHorariosNomina[registrosHorariosNomina.length - 1].fechaInput.value;
            const ultimaFechaObj = parseDateString(ultimaFechaStr);
            if (ultimaFechaObj) {
                ultimaFechaObj.setDate(ultimaFechaObj.getDate() + 1);
                fechaInput.value = ultimaFechaObj.toISOString().split('T')[0];
            } else {
                 fechaInput.value = new Date().toISOString().split('T')[0];
            }
        } else {
            fechaInput.value = new Date().toISOString().split('T')[0];
        }
        fechaCell.appendChild(fechaInput);

        const diaCell = document.createElement('td');
        diaCell.className = 'py-2.5 px-3 sm:px-4 text-sm text-gray-700 day-label';
        const diaSpan = document.createElement('span');
        diaCell.appendChild(diaSpan);

        const entradaCell = document.createElement('td');
        entradaCell.className = 'py-2.5 px-3 sm:px-4';
        const entradaInput = document.createElement('input');
        entradaInput.type = 'time';
        entradaInput.className = 'time-input p-2 border border-gray-300 rounded-md w-full text-sm';
        entradaInput.value = esDescansoProgramado ? '' : entrada;
        entradaCell.appendChild(entradaInput);

        const salidaCell = document.createElement('td');
        salidaCell.className = 'py-2.5 px-3 sm:px-4';
        const salidaInput = document.createElement('input');
        salidaInput.type = 'time';
        salidaInput.className = 'time-input p-2 border border-gray-300 rounded-md w-full text-sm';
        salidaInput.value = esDescansoProgramado ? '' : salida;
        salidaCell.appendChild(salidaInput); 

        const transporteCell = document.createElement('td');
        transporteCell.className = 'py-2.5 px-3 sm:px-4 text-center';
        const transporteCheck = document.createElement('input');
        transporteCheck.type = 'checkbox';
        transporteCheck.className = 'h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
        transporteCheck.checked = true; 
        transporteCell.appendChild(transporteCheck);

        const festivoCell = document.createElement('td');
        festivoCell.className = 'py-2.5 px-3 sm:px-4 text-center';
        const festivoCheck = document.createElement('input');
        festivoCheck.type = 'checkbox';
        festivoCheck.className = 'h-5 w-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-400';
        festivoCheck.checked = esFestivoPredefinido || festivosColombia2025.includes(fechaInput.value);
        festivoCell.appendChild(festivoCheck);

        const accionesCell = document.createElement('td');
        accionesCell.className = 'py-2.5 px-3 sm:px-4 no-print';
        const eliminarBtn = document.createElement('button');
        eliminarBtn.className = 'text-red-500 hover:text-red-700 transition-colors duration-150';
        eliminarBtn.innerHTML = '<i class="fas fa-trash-alt fa-lg"></i>';
        eliminarBtn.title = "Eliminar esta fila";
        eliminarBtn.addEventListener('click', () => {
            row.style.opacity = '0';
            row.style.transform = 'translateX(-100%)';
            setTimeout(() => {
                horariosTableBody.removeChild(row);
                registrosHorariosNomina = registrosHorariosNomina.filter(r => r.id !== id);
            }, 400);
        });
        accionesCell.appendChild(eliminarBtn);

        row.append(semanaCell, fechaCell, diaCell, entradaCell, salidaCell, transporteCell, festivoCell, accionesCell);
        horariosTableBody.appendChild(row);

        const nuevoRegistro = { id, row, fechaInput, diaSpan, entradaInput, salidaInput, transporteCheck, festivoCheck, semanaSpan };
        registrosHorariosNomina.push(nuevoRegistro);

        function actualizarInfoFilaPorFecha() {
            const fechaObj = parseDateString(fechaInput.value);
            if (fechaObj) {
                diaSpan.textContent = diasSemana[fechaObj.getDay()];
                semanaSpan.textContent = getWeekNumber(fechaObj);
                if (!isManualAdd && !esDescansoProgramado) { 
                     festivoCheck.checked = festivosColombia2025.includes(fechaInput.value);
                }
            } else {
                diaSpan.textContent = 'Inválida';
                semanaSpan.textContent = '-';
            }
            actualizarEstiloFila(nuevoRegistro);
            ordenarFilasPorFecha(); 
        }

        fechaInput.addEventListener('change', actualizarInfoFilaPorFecha);
        festivoCheck.addEventListener('change', () => actualizarEstiloFila(nuevoRegistro));
        
        actualizarInfoFilaPorFecha(); 
        
        if (isManualAdd) { 
             ordenarFilasPorFecha(); 
             row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
             fechaInput.focus(); 
        }
    }

    /**
     * Prellena la tabla de horarios de nómina con un rango de fechas y un tipo de turno.
     */
    function prellenarHorarios() {
        const fechaInicioStr = fechaInicioInput ? fechaInicioInput.value : '';
        const fechaFinStr = fechaFinInput ? fechaFinInput.value : '';
        const tipoTurno = tipoTurnoSelect ? tipoTurnoSelect.value : 'regular';
        const horasPorDiaTurno = parseFloat(horasPorDiaTurnoInput ? horasPorDiaTurnoInput.value : 0) || 0;
        
        if (!fechaInicioStr || !fechaFinStr) {
            console.error('Por favor, seleccione un rango de fechas (inicio y fin) para prellenar.');
            return;
        }
        if (fechaInicioStr > fechaFinStr) {
            console.error('La fecha de inicio no puede ser posterior a la fecha de fin.');
            return;
        }

        if (horariosTableBody) horariosTableBody.innerHTML = ''; 
        registrosHorariosNomina = [];

        const startDate = parseDateString(fechaInicioStr);
        const endDate = parseDateString(fechaFinStr);
        if (!startDate || !endDate) {
            console.error('Una de las fechas ingresadas no es válida.');
            return;
        }
        
        let currentDate = new Date(startDate);
        currentDate.setHours(0,0,0,0); 

        let shiftDayCounter = 0; // Para turnos rotativos (0-6 para ciclo de 7 días)

        while (currentDate <= endDate) {
            const fechaISO = currentDate.toISOString().split('T')[0];
            const diaSemanaNum = currentDate.getDay(); // 0 = Domingo
            const esFestivoConocido = festivosColombia2025.includes(fechaISO);
            
            let esDescansoDelTrabajador = false;
            let entradaHora = horaEntradaInput ? horaEntradaInput.value : '';
            let salidaHora = horaSalidaInput ? horaSalidaInput.value : '';

            if (tipoTurno === 'regular') {
                esDescansoDelTrabajador = (diaSemanaNum === 0); // Domingo
            } else if (tipoTurno === '4x3') {
                esDescansoDelTrabajador = (shiftDayCounter >= 4);
            } else if (tipoTurno === '5x2') {
                esDescansoDelTrabajador = (shiftDayCounter >= 5);
            } else if (tipoTurno === '4x3_rotativo') { 
                esDescansoDelTrabajador = (shiftDayCounter % 7 >= 4); 

                const weekNumber = getWeekNumber(currentDate);
                const isNightWeek = (weekNumber % 2 !== 0); 

                if (!esDescansoDelTrabajador) {
                    if (isNightWeek) {
                        entradaHora = "19:00"; 
                        salidaHora = "07:00"; 
                    } else {
                        entradaHora = "07:00"; 
                        salidaHora = "19:00"; 
                    }
                }
            }

            if (esDescansoDelTrabajador) {
                entradaHora = '';
                salidaHora = '';
            }

            agregarDia(fechaISO, { 
                esDescansoProgramado: esDescansoDelTrabajador, 
                esFestivoPredefinido: esFestivoConocido,
                isManualAdd: false, 
                entrada: entradaHora,
                salida: salidaHora
            });

            currentDate.setDate(currentDate.getDate() + 1);
            shiftDayCounter = (shiftDayCounter + 1) % 7; 
        }
        ordenarFilasPorFecha();
    }
    
    /**
     * Calcula la nómina del empleado.
     */
    function calcularNomina() {
        if (resultadosSeccion) resultadosSeccion.style.display = 'none';
        if (reciboNominaSectionWrapper) reciboNominaSectionWrapper.style.display = 'none';
        document.querySelectorAll('.print-target').forEach(el => el.classList.remove('print-target'));

        if (registrosHorariosNomina.length === 0) {
            console.error("Por favor, agrega o prellena horarios antes de calcular la nómina.");
            return;
        }

        const salarioMensual = parseFloat(salarioInput ? salarioInput.value : 0) || 0;
        if (salarioMensual === 0) {
            console.error("El salario mensual debe ser mayor a cero.");
            return;
        }
        const auxilioTransporteMensual = parseFloat(transporteInput ? transporteInput.value : 0) || 0;
        const jornadaSemanal = parseInt(jornadaSelect ? jornadaSelect.value : 46) || 46;
        const tipoTurno = tipoTurnoSelect ? tipoTurnoSelect.value : 'regular';
        const horasPorDiaTurno = parseFloat(horasPorDiaTurnoInput ? horasPorDiaTurnoInput.value : 0) || 0;

        const horasDescansoDiariasConfig = parseFloat(horasDescansoPeriodoInput ? horasDescansoPeriodoInput.value : 0) || 0;
        const valorReembolsoOtrosIngresos = parseFloat(reembolsoInput ? reembolsoInput.value : 0) || 0;
        const valorDescuentoOtrosConceptos = parseFloat(descuentoInput ? descuentoInput.value : 0) || 0;

        // Calcular valor hora ordinaria
        let horasMesCalculo;
        switch(jornadaSemanal) {
            case 47: horasMesCalculo = 235; break;
            case 46: horasMesCalculo = 230; break;
            case 44: horasMesCalculo = 220; break;
            case 42: horasMesCalculo = 210; break;
            case 48: horasMesCalculo = 240; break; // Referencia anterior
            default: horasMesCalculo = jornadaSemanal * (52/12); // Aproximación para otras jornadas
        }
        const valorHoraOrdinaria = salarioMensual / horasMesCalculo;

        let totalDiasTrabajadosPeriodo = 0;
        let totalDiasConDerechoAuxTransporte = 0;
        let totalDiasFestivosTrabajados = 0;

        let H_Ord_D = 0, H_Rec_Noc_Ord = 0, H_Ext_D = 0, H_Ext_Noc = 0;
        let H_Ord_DomFest_D = 0, H_Ord_DomFest_N_Con_Rec = 0; 
        let H_Ext_DomFest_D = 0, H_Ext_DomFest_N = 0;

        let jornadaDiariaTeorica;
        if (tipoTurno === 'regular') {
            jornadaDiariaTeorica = jornadaSemanal / 6; 
        } else {
            jornadaDiariaTeorica = horasPorDiaTurno; 
        }

        registrosHorariosNomina.forEach(reg => {
            const entradaStr = reg.entradaInput.value;
            const salidaStr = reg.salidaInput.value;
            
            if (!entradaStr || !salidaStr || (entradaStr === "00:00" && salidaStr === "00:00")) {
                return; 
            }

            // Para el cálculo de nómina (horas, recargos), sí se cuentan todos los días del mes.
            totalDiasTrabajadosPeriodo++; 
            if (reg.transporteCheck.checked) {
                totalDiasConDerechoAuxTransporte++;
            }

            const fechaDia = parseDateString(reg.fechaInput.value);
            const esDomingo = fechaDia.getDay() === 0;
            const esFestivo = reg.festivoCheck.checked;
            const esDomOFest = esDomingo || esFestivo;

            if (esDomOFest && (entradaStr !== "" && salidaStr !== "")) totalDiasFestivosTrabajados++;


            let entradaDec = timeToDecimal(entradaStr);
            let salidaDec = timeToDecimal(salidaStr);

            if (salidaDec < entradaDec) salidaDec += 24; 

            let horasLaboradasBrutas = salidaDec - entradaDec;
            let horasLaboradasNetas = Math.max(0, horasLaboradasBrutas - horasDescansoDiariasConfig);
            
            if (horasLaboradasNetas <= 0) return;

            let horasOrdinariasDelDia = Math.min(horasLaboradasNetas, jornadaDiariaTeorica);
            let horasExtrasDelDia = Math.max(0, horasLaboradasNetas - jornadaDiariaTeorica);

            for (let i = 0; i < horasOrdinariasDelDia; i += 1/60) { 
                const horaActualIteracion = entradaDec + i;
                const horaDelDia24Fmt = Math.floor(horaActualIteracion) % 24; 
                const esHoraNocturna = (horaDelDia24Fmt >= HORA_INICIO_NOCTURNA || horaDelDia24Fmt < HORA_FIN_NOCTURNA);

                if (esDomOFest) { 
                    if (esHoraNocturna) H_Ord_DomFest_N_Con_Rec += 1/60;
                    else H_Ord_DomFest_D += 1/60;
                } else { 
                    if (esHoraNocturna) H_Rec_Noc_Ord += 1/60;
                    else H_Ord_D += 1/60;
                }
            }

            const inicioExtrasDec = entradaDec + horasOrdinariasDelDia;
            for (let i = 0; i < horasExtrasDelDia; i += 1/60) {
                const horaActualIteracion = inicioExtrasDec + i;
                const horaDelDia24Fmt = Math.floor(horaActualIteracion) % 24;
                const esHoraNocturna = (horaDelDia24Fmt >= HORA_INICIO_NOCTURNA || horaDelDia24Fmt < HORA_FIN_NOCTURNA);
                
                if (esDomOFest) {
                    if (esHoraNocturna) H_Ext_DomFest_N += 1/60;
                    else H_Ext_D += 1/60;
                } else {
                    if (esHoraNocturna) H_Ext_Noc += 1/60;
                    else H_Ext_D += 1/60;
                }
            }
        });
        
        const roundToTwo = (num) => parseFloat(num.toFixed(2));
        H_Ord_D = roundToTwo(H_Ord_D);
        H_Rec_Noc_Ord = roundToTwo(H_Rec_Noc_Ord);
        H_Ext_D = roundToTwo(H_Ext_D);
        H_Ext_Noc = roundToTwo(H_Ext_Noc);
        H_Ord_DomFest_D = roundToTwo(H_Ord_DomFest_D);
        H_Ord_DomFest_N_Con_Rec = roundToTwo(H_Ord_DomFest_N_Con_Rec);
        H_Ext_DomFest_D = roundToTwo(H_Ext_DomFest_D);
        H_Ext_DomFest_N = roundToTwo(H_Ext_DomFest_N);

        const salarioBasicoPeriodo = (salarioMensual / 30) * totalDiasTrabajadosPeriodo; 
        
        const V_Ord_D = H_Ord_D * valorHoraOrdinaria;
        const V_Rec_Noc_Ord = H_Rec_Noc_Ord * valorHoraOrdinaria * RN_FACTOR; 
        const V_Ext_D = H_Ext_D * valorHoraOrdinaria * (1 + HED_FACTOR);
        const V_Ext_Noc = H_Ext_Noc * valorHoraOrdinaria * (1 + HEN_FACTOR);
        
        const V_Ord_DomFest_D = H_Ord_DomFest_D * valorHoraOrdinaria * (1 + HODF_FACTOR);
        const V_Ord_DomFest_N_Con_Rec = H_Ord_DomFest_N_Con_Rec * valorHoraOrdinaria * (1 + HODF_FACTOR + RN_FACTOR);
        
        const V_Ext_DomFest_D = H_Ext_DomFest_D * valorHoraOrdinaria * (1 + HODF_FACTOR + HED_FACTOR);
        const V_Ext_DomFest_N = H_Ext_DomFest_N * valorHoraOrdinaria * (1 + HODF_FACTOR + HEN_FACTOR);

        let valorAuxilioTransportePeriodo = 0;
        if (salarioMensual <= (2 * SMMLV) && totalDiasConDerechoAuxTransporte > 0) { // Using global SMMLV
            valorAuxilioTransportePeriodo = (AUX_TRANSPORTE_BASE / 30) * totalDiasConDerechoAuxTransporte; // Using global AUX_TRANSPORTE_BASE
        }
        
        const totalRecargosYExtras = V_Rec_Noc_Ord + V_Ext_D + V_Ext_Noc + V_Ord_DomFest_D + V_Ord_DomFest_N_Con_Rec + V_Ext_DomFest_D + V_Ext_DomFest_N;
        const totalDevengadoCalculado = salarioBasicoPeriodo + totalRecargosYExtras + valorAuxilioTransportePeriodo + valorReembolsoOtrosIngresos;

        let ingresoBaseCotizacion = salarioBasicoPeriodo + totalRecargosYExtras + valorReembolsoOtrosIngresos; 
        if (ingresoBaseCotizacion < SMMLV && totalDiasTrabajadosPeriodo >= 15 ) { 
             ingresoBaseCotizacion = SMMLV * (totalDiasTrabajadosPeriodo / 30);
             if (ingresoBaseCotizacion < (salarioBasicoPeriodo + totalRecargosYExtras + valorReembolsoOtrosIngresos)) { 
                ingresoBaseCotizacion = salarioBasicoPeriodo + totalRecargosYExtras + valorReembolsoOtrosIngresos;
             }
        } else if (ingresoBaseCotizacion < (SMMLV * (totalDiasTrabajadosPeriodo / 30) ) ) {
             ingresoBaseCotizacion = SMMLV * (totalDiasTrabajadosPeriodo / 30);
        }

        const deduccionSalud = ingresoBaseCotizacion * 0.04;
        const deduccionPension = ingresoBaseCotizacion * 0.04;
        const totalDeduccionesCalc = deduccionSalud + deduccionPension + valorDescuentoOtrosConceptos;
        const netoAPagar = totalDevengadoCalculado - totalDeduccionesCalc;

        if (document.getElementById('diasTrabajados')) document.getElementById('diasTrabajados').textContent = totalDiasTrabajadosPeriodo;
        if (document.getElementById('diasFestivos')) document.getElementById('diasFestivos').textContent = totalDiasFestivosTrabajados;
        if (document.getElementById('horasOrdinarias')) document.getElementById('horasOrdinarias').textContent = H_Ord_D.toFixed(2);
        if (document.getElementById('horasNocturnas')) document.getElementById('horasNocturnas').textContent = H_Rec_Noc_Ord.toFixed(2);
        if (document.getElementById('horasExtraDiurnas')) document.getElementById('horasExtraDiurnas').textContent = H_Ext_D.toFixed(2);
        if (document.getElementById('horasExtraNocturnas')) document.getElementById('horasExtraNocturnas').textContent = H_Ext_Noc.toFixed(2);
        if (document.getElementById('horasDominicalesDiurnas')) document.getElementById('horasDominicalesDiurnas').textContent = H_Ord_DomFest_D.toFixed(2);
        if (document.getElementById('horasDominicalesNocturnas')) document.getElementById('horasDominicalesNocturnas').textContent = H_Ord_DomFest_N_Con_Rec.toFixed(2);
        if (document.getElementById('horasExtraDominicalesDiurnas')) document.getElementById('horasExtraDominicalesDiurnas').textContent = H_Ext_DomFest_D.toFixed(2);
        if (document.getElementById('horasExtraDominicalesNocturnas')) document.getElementById('horasExtraDominicalesNocturnas').textContent = H_Ext_DomFest_N.toFixed(2);

        if (document.getElementById('salarioBaseCalculado')) document.getElementById('salarioBaseCalculado').textContent = formatCurrency(salarioBasicoPeriodo);
        if (document.getElementById('valorOrdinarias')) document.getElementById('valorOrdinarias').textContent = formatCurrency(V_Ord_D);
        if (document.getElementById('valorRecargoNocturno')) document.getElementById('valorRecargoNocturno').textContent = formatCurrency(V_Rec_Noc_Ord);
        if (document.getElementById('valorExtraDiurnas')) document.getElementById('valorExtraDiurnas').textContent = formatCurrency(V_Ext_D);
        if (document.getElementById('valorExtraNocturnas')) document.getElementById('valorExtraNocturnas').textContent = formatCurrency(V_Ext_Noc);
        if (document.getElementById('valorDominicalesDiurnas')) document.getElementById('valorDominicalesDiurnas').textContent = formatCurrency(V_Ord_DomFest_D);
        if (document.getElementById('valorDominicalesNocturnas')) document.getElementById('valorDominicalesNocturnas').textContent = formatCurrency(V_Ord_DomFest_N_Con_Rec);
        if (document.getElementById('valorExtraDominicalesDiurnas')) document.getElementById('valorExtraDominicalesDiurnas').textContent = formatCurrency(V_Ext_DomFest_D);
        if (document.getElementById('valorExtraDominicalesNocturnas')) document.getElementById('valorExtraDominicalesNocturnas').textContent = formatCurrency(V_Ext_DomFest_N);
        if (document.getElementById('valorTransporte')) document.getElementById('valorTransporte').textContent = formatCurrency(valorAuxilioTransportePeriodo);
        if (document.getElementById('valorReembolso')) document.getElementById('valorReembolso').textContent = formatCurrency(valorReembolsoOtrosIngresos);
        if (document.getElementById('totalDevengado')) document.getElementById('totalDevengado').textContent = formatCurrency(totalDevengadoCalculado);

        if (document.getElementById('deduccionSalud')) document.getElementById('deduccionSalud').textContent = formatCurrency(deduccionSalud);
        if (document.getElementById('deduccionPension')) document.getElementById('deduccionPension').textContent = formatCurrency(deduccionPension);
        if (document.getElementById('valorDescuento')) document.getElementById('valorDescuento').textContent = formatCurrency(valorDescuentoOtrosConceptos);
        if (document.getElementById('totalDeducciones')) document.getElementById('totalDeducciones').textContent = formatCurrency(totalDeduccionesCalc);
        if (document.getElementById('netoPagar')) document.getElementById('netoPagar').textContent = formatCurrency(netoAPagar);
        
        if (resultadosSeccion) resultadosSeccion.style.display = 'block';
        if (resultadosSeccion) resultadosSeccion.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Update receipt section (always populated, but only shown if activated)
        if (receiptFechaEmision) receiptFechaEmision.textContent = new Date().toLocaleDateString('es-CO');
        if (receiptNombre) receiptNombre.textContent = nombreInput ? nombreInput.value : 'N/A';
        if (receiptCedula) receiptCedula.textContent = cedulaInput ? cedulaInput.value : 'N/A';
        if (receiptSalarioMensual) receiptSalarioMensual.textContent = formatCurrency(salarioMensual);
        
        let minFecha = null;
        let maxFecha = null;

        registrosHorariosNomina.forEach(reg => {
            const fechaActual = parseDateString(reg.fechaInput.value);
            if (fechaActual) {
                if (minFecha === null || fechaActual < minFecha) {
                    minFecha = fechaActual;
                }
                if (maxFecha === null || fechaActual > maxFecha) {
                    maxFecha = fechaActual;
                }
            }
        });

        const fechaInicioPeriodo = minFecha ? minFecha.toISOString().split('T')[0] : 'N/A';
        const fechaFinPeriodo = maxFecha ? maxFecha.toISOString().split('T')[0] : 'N/A';

        if (receiptPeriodoLiquidacion) receiptPeriodoLiquidacion.textContent = `${fechaInicioPeriodo} - ${fechaFinPeriodo}`;
        
        if (receiptDiasTrabajados) receiptDiasTrabajados.textContent = totalDiasTrabajadosPeriodo; 
        if (receiptValorDiasTrabajados) receiptValorDiasTrabajados.textContent = formatCurrency(salarioBasicoPeriodo);
        if (receiptAuxilioTransporte) receiptAuxilioTransporte.textContent = formatCurrency(valorAuxilioTransportePeriodo);
        
        const otrosIngresosRecibo = valorReembolsoOtrosIngresos + totalRecargosYExtras;
        if (receiptOtrosIngresos) receiptOtrosIngresos.textContent = formatCurrency(otrosIngresosRecibo);
        
        if (receiptTotalDevengado) receiptTotalDevengado.textContent = formatCurrency(totalDevengadoCalculado);
        if (receiptDeduccionSalud) receiptDeduccionSalud.textContent = formatCurrency(deduccionSalud);
        if (receiptDeduccionPension) receiptDeduccionPension.textContent = formatCurrency(deduccionPension);
        if (receiptOtrosDescuentos) receiptOtrosDescuentos.textContent = formatCurrency(valorDescuentoOtrosConceptos);
        if (receiptTotalDeducciones) receiptTotalDeducciones.textContent = formatCurrency(totalDeduccionesCalc);
        if (receiptNetoPagar) receiptNetoPagar.textContent = formatCurrency(netoAPagar);
    }

    /**
     * Imprime la nómina detallada.
     */
    function printNomina() {
        calcularNomina(); 
        document.body.classList.add('print-mode-nomina');
        window.print();
        document.body.classList.remove('print-mode-nomina'); 
    }

    /**
     * Muestra el recibo de nómina para imprimir.
     */
    function mostrarReciboParaImprimir() {
        calcularNomina(); 
        if (resultadosSeccion) resultadosSeccion.style.display = 'none';
        if (reciboNominaSectionWrapper) reciboNominaSectionWrapper.style.display = 'block'; 

        document.body.classList.add('print-mode-recibo');
        if (reciboNominaContainer) {
            reciboNominaContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    /**
     * Imprime el recibo de nómina.
     */
    function printRecibo() {
        window.print();
    }

    /**
     * Vuelve a la sección de resultados de nómina desde el recibo.
     */
    function volverAResultados() {
        if (reciboNominaSectionWrapper) reciboNominaSectionWrapper.style.display = 'none'; 
        document.body.classList.remove('print-mode-recibo'); 

        if (resultadosSeccion) resultadosSeccion.style.display = 'block';
        if (resultadosSeccion) resultadosSeccion.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /**
     * Maneja la visibilidad del input de horas por día de turno en la sección de Nómina.
     */
    function toggleHorasPorDiaTurnoInput() {
        const tipoTurno = tipoTurnoSelect ? tipoTurnoSelect.value : 'regular';
        if (horasPorDiaTurnoContainer) {
            if (tipoTurno === '4x3' || tipoTurno === '5x2' || tipoTurno === '4x3_rotativo') {
                horasPorDiaTurnoContainer.style.display = 'block';
                if (horasPorDiaTurnoInput) {
                    if (tipoTurno === '4x3_rotativo') {
                        horasPorDiaTurnoInput.value = '10.5'; 
                        if (horasDescansoPeriodoInput) horasDescansoPeriodoInput.value = '1.5'; 
                    } else {
                        horasPorDiaTurnoInput.value = (tipoTurno === '4x3') ? '10' : '8'; 
                    }
                }
            } else {
                horasPorDiaTurnoContainer.style.display = 'none';
                if (horasDescansoPeriodoInput && horasDescansoPeriodoInput.value === '1.5') {
                    horasDescansoPeriodoInput.value = '1'; 
                }
            }
        }
    }

    /**
     * Guarda los datos de la nómina en Google Sheets.
     */
    async function guardarDatosEnSheets() {
        calcularNomina(); // Asegurarse de que los resultados estén actualizados

        const nombreEmpresa = nombreEmpresaInput ? nombreEmpresaInput.value : '';
        const nombreCompleto = nombreInput ? nombreInput.value : '';
        const numeroIdentificacion = cedulaInput ? cedulaInput.value : '';
        const fechaInicioPeriodo = fechaInicioInput ? fechaInicioInput.value : '';
        const fechaFinPeriodo = fechaFinInput ? fechaFinInput.value : '';
        const diasTrabajados = document.getElementById('diasTrabajados')?.textContent || '0';
        const salarioBase = parseFloat(salarioInput ? salarioInput.value : 0);
        const horasOrdinariasDiurnas = document.getElementById('horasOrdinarias')?.textContent || '0';
        const horasRecargoNocturno = document.getElementById('horasNocturnas')?.textContent || '0';
        const horasExtraDiurnas = document.getElementById('horasExtraDiurnas')?.textContent || '0';
        const horasExtraNocturnas = document.getElementById('horasExtraNocturnas')?.textContent || '0';
        const horasRecargoNocturnoJornada = document.getElementById('horasNocturnas')?.textContent || '0'; // Se usa el mismo valor que horasRecargoNocturno
        const horasDominicalesDiurnas = document.getElementById('horasDominicalesDiurnas')?.textContent || '0';
        const horasDominicalesNocturnas = document.getElementById('horasDominicalesNocturnas')?.textContent || '0';
        const horasExtraDominicalesDiurnas = document.getElementById('horasExtraDominicalesDiurnas')?.textContent || '0';
        const horasExtraDominicalesNocturnas = document.getElementById('horasExtraDominicalesNocturnas')?.textContent || '0';
        const valorAuxilioTransporte = document.getElementById('valorTransporte')?.textContent || '$0';
        const valorReembolso = document.getElementById('valorReembolso')?.textContent || '$0';
        const totalDevengado = document.getElementById('totalDevengado')?.textContent || '$0';
        const deduccionSalud = document.getElementById('deduccionSalud')?.textContent || '$0';
        const deduccionPension = document.getElementById('deduccionPension')?.textContent || '$0';
        const valorDescuento = document.getElementById('valorDescuento')?.textContent || '$0';
        const totalDeducciones = document.getElementById('totalDeducciones')?.textContent || '$0';
        const netoPagar = document.getElementById('netoPagar')?.textContent || '$0';

        const detallesHorarios = registrosHorariosNomina.map(reg => ({
            fecha: reg.fechaInput.value,
            dia: reg.diaSpan.textContent,
            entrada: reg.entradaInput.value,
            salida: reg.salidaInput.value,
            aplicaTransporte: reg.transporteCheck.checked,
            festivo: reg.festivoCheck.checked
        }));

        const datosParaGuardar = {
            nombreEmpresa: nombreEmpresa,
            nombreCompleto: nombreCompleto,
            numeroIdentificacion: numeroIdentificacion,
            fechaInicioPeriodo: fechaInicioPeriodo,
            fechaFinPeriodo: fechaFinPeriodo,
            diasTrabajados: parseFloat(diasTrabajados),
            salarioBase: salarioBase,
            horasOrdinariasDiurnas: parseFloat(horasOrdinariasDiurnas),
            horasRecargoNocturno: parseFloat(horasRecargoNocturno),
            horasExtraDiurnas: parseFloat(horasExtraDiurnas),
            horasExtraNocturnas: parseFloat(horasExtraNocturnas),
            horasRecargoNocturnoJornada: parseFloat(horasRecargoNocturnoJornada),
            horasDominicalesDiurnas: parseFloat(horasDominicalesDiurnas),
            horasDominicalesNocturnas: parseFloat(horasDominicalesNocturnas),
            horasExtraDominicalesDiurnas: parseFloat(horasExtraDominicalesDiurnas),
            horasExtraDominicalesNocturnas: parseFloat(horasExtraDominicalesNocturnas),
            valorAuxilioTransporte: parseFloat(valorAuxilioTransporte.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            valorReembolso: parseFloat(valorReembolso.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            totalDevengado: parseFloat(totalDevengado.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            deduccionSalud: parseFloat(deduccionSalud.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            deduccionPension: parseFloat(deduccionPension.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            valorDescuento: parseFloat(valorDescuento.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            totalDeducciones: parseFloat(totalDeducciones.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            netoPagar: parseFloat(netoPagar.replace(/[^0-9,-]+/g,"").replace(",", ".")),
            detallesHorarios: detallesHorarios
        };

        // URL de tu Google Apps Script desplegado como aplicación web
        const urlAppsScript = 'https://script.google.com/macros/s/AKfycbyvwlqVfY3z07uM_VWrgHqNdAZQImfBSBSyFA2AgcJ5JHMSnO8FynmveqWCfM6KL_EG/exec'; 

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.text(); 
            if (response.ok) {
                showMessageModal('¡Éxito!', '¡Datos guardados en Google Sheets exitosamente!', 'success');
                console.log('Respuesta de Apps Script:', result);
            } else {
                showMessageModal('Error', 'Error al guardar datos. Revisa la consola para más detalles.', 'error');
                console.error('Error de Apps Script:', result);
            }
        } catch (error) {
            console.error('Error de conexión o al enviar datos:', error);
            showMessageModal('Error', 'Hubo un error al intentar guardar los datos. Verifica tu conexión o la URL del script.', 'error');
        }
    }


    // --- Lógica de la Calculadora de Carga Prestacional ---
    /**
     * Simula las horas trabajadas en un mes típico (30 días) según el tipo de turno.
     * @param {string} tipoTurno - Tipo de turno ('regular', '4x3', '5x2', '4x3_rotativo').
     * @param {number} horasPorDiaTurno - Horas netas por día de turno (para 4x3, 5x2, 4x3_rotativo).
     * @param {string} horaEntradaStr - Hora de entrada del turno (HH:MM).
     * @param {string} horaSalidaStr - Hora de salida del turno (HH:MM).
     * @param {number} horasDescansoDiario - Horas de descanso diarias (almuerzo, etc.).
     * @param {string} diaDescansoRegular - Día de descanso para turno regular ('domingo', 'sabado', etc.).
     * @param {number} jornadaSemanal - Jornada laboral semanal (para determinar horas ordinarias diarias).
     * @returns {object} Un objeto con las horas estimadas por categoría (H_Ord_D, H_Rec_Noc_Ord, etc.).
     */
    function simularHorasMensualesPorTurno(tipoTurno, horasPorDiaTurno, horaEntradaStr, horaSalidaStr, horasDescansoDiario, diaDescansoRegular, jornadaSemanal) {
        let H_Ord_D = 0, H_Rec_Noc_Ord = 0, H_Ext_D = 0, H_Ext_Noc = 0;
        let H_Ord_DomFest_D = 0, H_Ord_DomFest_N_Con_Rec = 0;
        let H_Ext_DomFest_D = 0, H_Ext_DomFest_N = 0;

        const DIAS_MES_SIMULACION = 30; 
        const diasSemanaMap = {
            'domingo': 0, 'lunes': 1, 'martes': 2, 'miércoles': 3, 'jueves': 4, 'viernes': 5, 'sábado': 6
        };
        const diaDescansoNum = diasSemanaMap[diaDescansoRegular.toLowerCase()];

        const currentYear = new Date().getFullYear();
        const festivosThisYear = festivosColombia2025.filter(dateStr => dateStr.startsWith(currentYear.toString()));

        let shiftDayCounter = 0; 

        for (let i = 0; i < DIAS_MES_SIMULACION; i++) {
            const simulatedDate = new Date(currentYear, 0, 1); 
            simulatedDate.setDate(simulatedDate.getDate() + i); 
            const diaSemanaActualNum = simulatedDate.getDay(); 
            const fechaISO = simulatedDate.toISOString().split('T')[0];
            const esFestivo = festivosThisYear.includes(fechaISO);

            let esDiaTrabajo = false;
            let currentEntrada = horaEntradaStr;
            let currentSalida = horaSalidaStr;

            if (tipoTurno === 'regular') {
                esDiaTrabajo = (diaSemanaActualNum !== diaDescansoNum);
            } else if (tipoTurno === '4x3') {
                esDiaTrabajo = (shiftDayCounter % 7 < 4); 
            } else if (tipoTurno === '5x2') {
                esDiaTrabajo = (shiftDayCounter % 7 < 5); 
            } else if (tipoTurno === '4x3_rotativo') { 
                esDiaTrabajo = (shiftDayCounter % 7 < 4); 

                const weekNumber = getWeekNumber(simulatedDate);
                const isNightWeek = (weekNumber % 2 !== 0); 

                if (!esDiaTrabajo) {
                    if (isNightWeek) {
                        currentEntrada = "19:00"; 
                        currentSalida = "07:00"; 
                    } else {
                        currentEntrada = "07:00"; 
                        currentSalida = "19:00"; 
                    }
                }
            }

            if (esDiaTrabajo) {
                let entradaDec = timeToDecimal(currentEntrada); 
                let salidaDec = timeToDecimal(currentSalida); 

                if (salidaDec < entradaDec) salidaDec += 24;

                let horasLaboradasBrutas = salidaDec - entradaDec;
                let horasLaboradasNetas = Math.max(0, horasLaboradasBrutas - horasDescansoDiario);

                if (horasLaboradasNetas <= 0) continue;

                const jornadaDiariaTeorica = tipoTurno === 'regular' ? (jornadaSemanal / 6) : horasPorDiaTurno;

                let horasOrdinariasDelDia = Math.min(horasLaboradasNetas, jornadaDiariaTeorica);
                let horasExtrasDelDia = Math.max(0, horasLaboradasNetas - jornadaDiariaTeorica);

                const esDomOFest = (diaSemanaActualNum === 0 || esFestivo);

                for (let h = 0; h < horasOrdinariasDelDia; h += 1/60) {
                    const horaActualIteracion = entradaDec + h;
                    const horaDelDia24Fmt = Math.floor(horaActualIteracion) % 24;
                    const esHoraNocturna = (horaDelDia24Fmt >= HORA_INICIO_NOCTURNA || horaDelDia24Fmt < HORA_FIN_NOCTURNA);

                    if (esDomOFest) {
                        if (esHoraNocturna) H_Ord_DomFest_N_Con_Rec += 1/60;
                        else H_Ord_DomFest_D += 1/60;
                    } else {
                        if (esHoraNocturna) H_Rec_Noc_Ord += 1/60;
                        else H_Ord_D += 1/60;
                    }
                }

                const inicioExtrasDec = entradaDec + horasOrdinariasDelDia;
                for (let h = 0; h < horasExtrasDelDia; h += 1/60) {
                    const horaActualIteracion = inicioExtrasDec + h;
                    const horaDelDia24Fmt = Math.floor(horaActualIteracion) % 24;
                    const esHoraNocturna = (horaDelDia24Fmt >= HORA_INICIO_NOCTURNA || horaDelDia24Fmt < HORA_FIN_NOCTURNA);

                    if (esDomOFest) {
                        if (esHoraNocturna) H_Ext_DomFest_N += 1/60;
                        else H_Ext_D += 1/60;
                    } else {
                        if (esHoraNocturna) H_Ext_Noc += 1/60;
                        else H_Ext_D += 1/60;
                    }
                }
            }
            shiftDayCounter++;
        }

        const roundToTwo = (num) => parseFloat(num.toFixed(2));

        return {
            H_Ord_D: roundToTwo(H_Ord_D),
            H_Rec_Noc_Ord: roundToTwo(H_Rec_Noc_Ord),
            H_Ext_D: roundToTwo(H_Ext_D),
            H_Ext_Noc: roundToTwo(H_Ext_Noc),
            H_Ord_DomFest_D: roundToTwo(H_Ord_DomFest_D),
            H_Ord_DomFest_N_Con_Rec: roundToTwo(H_Ord_DomFest_N_Con_Rec),
            H_Ext_DomFest_D: roundToTwo(H_Ext_DomFest_D),
            H_Ext_DomFest_N: roundToTwo(H_Ext_DomFest_N)
        };
    }

    /**
     * Calcula la carga prestacional mensual y anual para un solo empleado.
     * @param {object} datos - Objeto con los datos de entrada del empleado.
     * @returns {object} Objeto con los resultados detallados del cálculo.
     */
    function calcularCargaPrestacionalPorEmpleado(datos) {
        let {
            salarioBase, bonosNoPrestacionales, auxTransporteSi, valorDotacionUnaEntrega, tiempoTrabajoMeses,
            tipoContrato, esPensionadoSi, exencionParafiscalesSi, tipoRiesgoARL, esSalarioIntegral,
            tipoTurnoCarga, horasPorDiaTurnoCarga, horaEntradaCarga, horaSalidaCarga, horasDescansoDiarioCarga, diaDescansoRegularCarga
        } = datos;

        salarioBase = parseFloat(salarioBase) || 0;
        bonosNoPrestacionales = parseFloat(bonosNoPrestacionales) || 0;
        valorDotacionUnaEntrega = parseFloat(valorDotacionUnaEntrega) || 0;
        tiempoTrabajoMeses = parseInt(tiempoTrabajoMeses) || 12;

        let resultados = {
            salarioBase: salarioBase,
            bonosNoPrestacionales: bonosNoPrestacionales,
            valorAuxTransporte: 0,
            costoDotacionMensual: 0,
            ibc: 0,
            aporteSaludEmpleador: 0,
            aportePensionEmpleador: 0,
            aporteARL: 0,
            aporteCajaCompensacion: 0,
            aporteSENA: 0,
            aporteICBF: 0,
            provisionCesantias: 0,
            provisionInteresesCesantias: 0,
            provisionPrima: 0,
            provisionVacaciones: 0,
            costoTotalMensualPorEmpleado: 0,
            costoTotalAnualPorEmpleado: 0,
            porcentajeCargaPrestacional: 0,
            esSalarioIntegral: esSalarioIntegral,
            tipoContrato: tipoContrato,
            esPensionadoSi: esPensionadoSi,
            exencionParafiscalesSi: exencionParafiscalesSi, // Ensure this is stored
            estimatedRecargosExtras: 0, 
            estimatedHours: {}, 
            tiempoTrabajoMeses: tiempoTrabajoMeses,
            tipoRiesgoARL: tipoRiesgoARL,
            tipoTurnoCarga: tipoTurnoCarga,
            horasPorDiaTurnoCarga: horasPorDiaTurnoCarga,
            horaEntradaCarga: horaEntradaCarga,
            horaSalidaCarga: horaSalidaCarga,
            horasDescansoDiarioCarga: horasDescansoDiarioCarga,
            diaDescansoRegularCarga: diaDescansoRegularCarga
        };

        const aplicaAuxTransporteLegal = (salarioBase <= (2 * SMMLV));
        const aplicaDotacionLegal = (salarioBase <= (2 * SMMLV));

        const noAplicaLegalmente = esSalarioIntegral || tipoContrato === 'servicio' || tipoContrato === 'aprendizaje';

        if (auxTransporteSi && !noAplicaLegalmente) {
            if (!aplicaAuxTransporteLegal) {
                 // Removed confirm based on previous instructions, just assume it's extralegal if paid
                resultados.valorAuxTransporte = AUX_TRANSPORTE_BASE;
            } else if (aplicaAuxTransporteLegal) {
                resultados.valorAuxTransporte = AUX_TRANSPORTE_BASE;
            }
        }

        if (valorDotacionUnaEntrega > 0 && !noAplicaLegalmente) {
            if (!aplicaDotacionLegal) {
                // Removed confirm based on previous instructions
                resultados.costoDotacionMensual = (valorDotacionUnaEntrega * 3) / 12;
            } else if (aplicaDotacionLegal) {
                resultados.costoDotacionMensual = (valorDotacionUnaEntrega * 3) / 12;
            }
        }

        let ibc = 0;
        if (tipoContrato === 'servicio') {
            ibc = salarioBase * 0.40;
        } else if (esSalarioIntegral) {
            ibc = salarioBase * 0.70;
        } else {
            ibc = salarioBase;
        }

        if (ibc < SMMLV) ibc = SMMLV;
        if (ibc > TOPE_IBC) ibc = TOPE_IBC;
        resultados.ibc = ibc;

        if (tipoContrato !== 'servicio') {
            if (!esPensionadoSi) {
                if (!(exencionParafiscalesSi && salarioBase < (10 * SMMLV))) {
                    resultados.aporteSaludEmpleador = ibc * SALUD_EMPLEADOR;
                }
                if (tipoContrato !== 'aprendizaje') {
                    resultados.aportePensionEmpleador = ibc * PENSION_EMPLEADOR;
                }
            }
            if (tipoContrato === 'aprendizaje') {
                resultados.aporteARL = salarioBase * TARIFAS_ARL[tipoRiesgoARL];
            } else {
                resultados.aporteARL = ibc * TARIFAS_ARL[tipoRiesgoARL];
            }
        }

        if (tipoContrato !== 'servicio' && tipoContrato !== 'aprendizaje') {
            resultados.aporteCajaCompensacion = ibc * CAJA_COMPENSACION;
            if (!(exencionParafiscalesSi && salarioBase < (10 * SMMLV))) {
                resultados.aporteSENA = ibc * SENA;
                resultados.aporteICBF = ibc * ICBF;
            }
        }

        if (tipoContrato === 'indefinido' || tipoContrato === 'fijo' || tipoContrato === 'obra') {
            if (!esSalarioIntegral) {
                const basePrestaciones = salarioBase + resultados.valorAuxTransporte;

                // Ajuste para provisión de cesantías, prima y vacaciones
                // si el tiempo de trabajo es menor a 12 meses, se prorratea
                resultados.provisionCesantias = (basePrestaciones * CESANTIAS_FACTOR);
                resultados.provisionInteresesCesantias = (resultados.provisionCesantias * INTERESES_CESANTIAS_FACTOR); // Intereses son sobre las cesantías
                resultados.provisionPrima = (basePrestaciones * PRIMA_FACTOR);
                resultados.provisionVacaciones = (salarioBase * VACACIONES_FACTOR);
            }
        }

        const jornadaSemanalActual = parseInt(jornadaSelect ? jornadaSelect.value : 46) || 46;

        const estimatedHours = simularHorasMensualesPorTurno(
            tipoTurnoCarga,
            horasPorDiaTurnoCarga,
            horaEntradaCarga,
            horaSalidaCarga,
            horasDescansoDiarioCarga,
            diaDescansoRegularCarga,
            jornadaSemanalActual
        );

        const valorHoraOrdinariaCarga = salarioBase / (jornadaSemanalActual * (52 / 12));

        const V_Rec_Noc_Ord_Est = estimatedHours.H_Rec_Noc_Ord * valorHoraOrdinariaCarga * RN_FACTOR;
        const V_Ext_D_Est = estimatedHours.H_Ext_D * valorHoraOrdinariaCarga * (1 + HED_FACTOR);
        const V_Ext_Noc_Est = estimatedHours.H_Ext_Noc * valorHoraOrdinariaCarga * (1 + HEN_FACTOR);
        const V_Ord_DomFest_D_Est = estimatedHours.H_Ord_DomFest_D * valorHoraOrdinariaCarga * (1 + HODF_FACTOR);
        const V_Ord_DomFest_N_Con_Rec_Est = estimatedHours.H_Ord_DomFest_N_Con_Rec * valorHoraOrdinariaCarga * (1 + HODF_FACTOR + RN_FACTOR);
        const V_Ext_DomFest_D_Est = estimatedHours.H_Ext_DomFest_D * valorHoraOrdinariaCarga * (1 + HODF_FACTOR + HED_FACTOR);
        const V_Ext_DomFest_N_Est = estimatedHours.H_Ext_DomFest_N * valorHoraOrdinariaCarga * (1 + HODF_FACTOR + HEN_FACTOR);

        const totalEstimatedRecargosExtras = V_Rec_Noc_Ord_Est + V_Ext_D_Est + V_Ext_Noc_Est +
                                             V_Ord_DomFest_D_Est + V_Ord_DomFest_N_Con_Rec_Est +
                                             V_Ext_DomFest_D_Est + V_Ext_DomFest_N_Est;

        resultados.estimatedRecargosExtras = totalEstimatedRecargosExtras;
        resultados.estimatedHours = estimatedHours;

        const costoMensualSeguridadSocial = resultados.aporteSaludEmpleador + resultados.aportePensionEmpleador + resultados.aporteARL;
        const costoMensualParafiscales = results.aporteCajaCompensacion + results.aporteSENA + results.aporteICBF;
        const costoMensualPrestacionesSociales = resultados.provisionCesantias + resultados.provisionInteresesCesantias + resultados.provisionPrima + resultados.provisionVacaciones;

        resultados.costoTotalMensualPorEmpleado = salarioBase + bonosNoPrestacionales + resultados.valorAuxTransporte +
                                                  costoMensualSeguridadSocial + costoMensualParafiscales +
                                                  costoMensualPrestacionesSociales + resultados.costoDotacionMensual +
                                                  totalEstimatedRecargosExtras; 

        resultados.costoTotalAnualPorEmpleado = resultados.costoTotalMensualPorEmpleado * tiempoTrabajoMeses;

        const baseParaPorcentaje = salarioBase + bonosNoPrestacionales + totalEstimatedRecargosExtras; 
        if (baseParaPorcentaje > 0) {
            const costoAdicional = resultados.costoTotalMensualPorEmpleado - baseParaPorcentaje;
            resultados.porcentajeCargaPrestacional = costoAdicional / baseParaPorcentaje;
        } else {
            resultados.porcentajeCargaPrestacional = 0;
        }

        return resultados;
    }

    /**
     * Agrega un nuevo cargo a la tabla de resultados de Carga Prestacional.
     */
    function agregarCargo() {
        const cargoNombre = document.getElementById('carga_inputCargoNombre')?.value;
        const numEmpleados = parseInt(document.getElementById('carga_inputNumEmpleados')?.value || 0);
        const salarioBase = parseFloat(document.getElementById('carga_inputSalarioBase')?.value || 0);
        const esSalarioIntegral = document.querySelector('input[name="carga_inputSalarioIntegral"]:checked')?.value === 'si';
        const bonosNoPrestacionales = parseFloat(document.getElementById('carga_inputBonosNoPrestacionales')?.value || 0);
        const auxTransporteSi = document.querySelector('input[name="carga_inputAuxTransporte"]:checked')?.value === 'si';
        const valorDotacionUnaEntrega = parseFloat(document.getElementById('carga_inputValorDotacionEntrega')?.value || 0);
        const tiempoTrabajoMeses = parseInt(document.getElementById('carga_inputTiempoTrabajoMeses')?.value || 0);
        const tipoContrato = document.getElementById('carga_inputTipoContrato')?.value;
        const esPensionadoSi = document.querySelector('input[name="carga_inputEsPensionado"]:checked')?.value === 'si';
        const exencionParafiscalesSi = document.querySelector('input[name="carga_inputExencionParafiscales"]:checked')?.value === 'si';
        const tipoRiesgoARL = parseInt(document.getElementById('carga_inputTipoRiesgoARL')?.value || 0);
        const tipoTurnoCarga = document.getElementById('carga_tipoTurno')?.value;
        const horasPorDiaTurnoCarga = parseFloat(document.getElementById('carga_horasPorDiaTurno')?.value || 0);
        const diaDescansoRegularCarga = document.getElementById('carga_descansoRegular')?.value;
        const horaEntradaCarga = document.getElementById('carga_horaEntrada')?.value;
        const horaSalidaCarga = document.getElementById('carga_horaSalida')?.value;
        const horasDescansoDiarioCarga = parseFloat(document.getElementById('carga_horasDescansoDiario')?.value || 0);


        if (!cargoNombre || isNaN(numEmpleados) || isNaN(salarioBase) || salarioBase <= 0) {
            console.error('Por favor, complete los campos obligatorios: Nombre del Cargo, Número de Empleados y Salario Base (debe ser mayor a 0).');
            return;
        }
        if (isNaN(tiempoTrabajoMeses) || tiempoTrabajoMeses < 1 || tiempoTrabajoMeses > 12) {
            console.error('Por favor, ingrese un valor válido para "Tiempo de Trabajo" (entre 1 y 12 meses).');
            return;
        }
        if ((tipoTurnoCarga === '4x3' || tipoTurnoCarga === '5x2' || tipoTurnoCarga === '4x3_rotativo') && (isNaN(horasPorDiaTurnoCarga) || horasPorDiaTurnoCarga <= 0)) {
            console.error('Por favor, ingrese las "Horas por Día de Turno" para turnos rotativos.');
            return;
        }
        if (!horaEntradaCarga || !horaSalidaCarga) {
            console.error('Por favor, ingrese la Hora de Entrada y Hora de Salida para el turno.');
            return;
        }


        const salarioIntegralMinimoLegal = (10 * SMMLV) + (10 * SMMLV * 0.30);
        if (esSalarioIntegral && salarioBase < salarioIntegralMinimoLegal) {
            console.warn(`Un salario integral debe ser al menos ${formatCurrency(salarioIntegralMinimoLegal)}. El salario ingresado (${formatCurrency(salarioBase)}) es menor. Esto podría afectar la validez legal y el tratamiento fiscal.`);
        }

        const datosCalculo = {
            salarioBase, bonosNoPrestacionales, auxTransporteSi, valorDotacionUnaEntrega, tiempoTrabajoMeses,
            tipoContrato, esPensionadoSi, exencionParafiscalesSi, tipoRiesgoARL, esSalarioIntegral,
            tipoTurnoCarga, horasPorDiaTurnoCarga, horaEntradaCarga, horaSalidaCarga, horasDescansoDiarioCarga, diaDescansoRegularCarga
        };

        const resultados = calcularCargaPrestacionalPorEmpleado(datosCalculo);

        const tablaBody = document.querySelector('#cargosTable tbody');
        const newRow = tablaBody.insertRow();

        newRow.setAttribute('data-resultados', JSON.stringify(resultados));
        newRow.setAttribute('data-cargo-nombre', cargoNombre);
        newRow.setAttribute('data-num-empleados', numEmpleados);
        newRow.setAttribute('data-tiempo-trabajo-meses', tiempoTrabajoMeses); 

        const costoDirectoMensual = salarioBase + bonosNoPrestacionales + resultados.valorAuxTransporte + resultados.estimatedRecargosExtras; 

        newRow.innerHTML = `
            <td>${cargoNombre}</td>
            <td>${numEmpleados}</td>
            <td class="currency">${formatCurrency(salarioBase)}</td>
            <td class="currency">${formatCurrency(costoDirectoMensual)}</td>
            <td>${tipoContrato === 'indefinido' ? 'Indefinido' : tipoContrato === 'fijo' ? 'Fijo' : tipoContrato === 'obra' ? 'Obra' : tipoContrato === 'aprendizaje' ? 'Aprendizaje' : 'Servicios'} ${esSalarioIntegral ? '(Integral)' : ''}</td>
            <td>${resultados.estimatedHours.H_Ord_D.toFixed(2)}</td>
            <td class="currency">${formatCurrency(resultados.estimatedRecargosExtras)}</td>
            <td class="currency">${formatCurrency(resultados.costoTotalMensualPorEmpleado)}</td>
            <td class="currency">${formatCurrency(resultados.costoTotalMensualPorEmpleado * numEmpleados)}</td>
            <td class="currency">${formatCurrency(resultados.costoTotalMensualPorEmpleado * numEmpleados * tiempoTrabajoMeses)}</td>
            <td class="no-print">
                <button type="button" class="detail-row-btn" onclick="mostrarDetallePorFila(this)">Ver Detalle</button>
                <button type="button" class="edit-row-btn" onclick="editarFila(this)">Editar</button>
                <button type="button" class="delete-row-btn" onclick="eliminarFila(this)">Eliminar</button>
            </td>
        `;

        actualizarTotalesGenerales();
        limpiarFormularioCargaPrestacional();
    }

    /**
     * Elimina una fila de la tabla de cargos de Carga Prestacional.
     * @param {HTMLButtonElement} button - El botón "Eliminar" que fue clickeado.
     */
    function eliminarFila(button) {
        const row = button.closest('tr');
        row.remove();
        actualizarTotalesGenerales();
    }

    /**
     * Edita una fila de la tabla de cargos de Carga Prestacional, precargando el formulario.
     * @param {HTMLButtonElement} button - El botón "Editar" que fue clickeado.
     */
    function editarFila(button) {
        const row = button.closest('tr');
        const resultados = JSON.parse(row.getAttribute('data-resultados'));
        const cargoNombre = row.getAttribute('data-cargo-nombre');
        const numEmpleados = parseInt(row.getAttribute('data-num-empleados'));

        document.getElementById('carga_inputCargoNombre').value = cargoNombre;
        document.getElementById('carga_inputNumEmpleados').value = numEmpleados;
        document.getElementById('carga_inputSalarioBase').value = resultados.salarioBase;
        document.querySelector(`input[name="carga_inputSalarioIntegral"][value="${resultados.esSalarioIntegral ? 'si' : 'no'}"]`).checked = true;
        document.getElementById('carga_inputBonosNoPrestacionales').value = resultados.bonosNoPrestacionales;
        document.querySelector(`input[name="carga_inputAuxTransporte"][value="${resultados.valorAuxTransporte > 0 ? 'si' : 'no'}"]`).checked = true; 
        document.getElementById('carga_inputValorDotacionEntrega').value = resultados.costoDotacionMensual > 0 ? (resultados.costoDotacionMensual * 12 / 3) : 0; 
        document.getElementById('carga_inputTiempoTrabajoMeses').value = resultados.tiempoTrabajoMeses;
        document.getElementById('carga_inputTipoContrato').value = resultados.tipoContrato;
        document.querySelector(`input[name="carga_inputEsPensionado"][value="${resultados.esPensionadoSi ? 'si' : 'no'}"]`).checked = true;
        document.querySelector(`input[name="carga_inputExencionParafiscales"][value="${resultados.exencionParafiscalesSi ? 'si' : 'no'}"]`).checked = true;
        document.getElementById('carga_inputTipoRiesgoARL').value = resultados.tipoRiesgoARL;

        document.getElementById('carga_tipoTurno').value = resultados.tipoTurnoCarga || 'regular';
        document.getElementById('carga_descansoRegular').value = resultados.diaDescansoRegularCarga || 'domingo';
        document.getElementById('carga_horaEntrada').value = resultados.horaEntradaCarga || '07:00';
        document.getElementById('carga_horaSalida').value = resultados.horaSalidaCarga || '16:00';
        
        applyFieldRestrictions();
        toggleCargaHorasPorDiaTurnoInput(); 

        if (document.getElementById('carga_horasPorDiaTurno')) document.getElementById('carga_horasPorDiaTurno').value = resultados.horasPorDiaTurnoCarga || 10;
        if (document.getElementById('carga_horasDescansoDiario')) document.getElementById('carga_horasDescansoDiario').value = resultados.horasDescansoDiarioCarga || 1;

        row.remove();
        actualizarTotalesGenerales();
    }

    /**
     * Actualiza los totales mensuales y anuales en la fila de pie de tabla de Carga Prestacional.
     */
    function actualizarTotalesGenerales() {
        let totalMensualGeneral = 0;
        let totalAnualGeneral = 0;
        let salarioBaseTotalGeneral = 0;
        let bonosNoPrestacionalesTotalGeneral = 0;
        let totalEmpleadosGlobal = 0;

        document.querySelectorAll('#cargosTable tbody tr').forEach(row => {
            const resultados = JSON.parse(row.getAttribute('data-resultados'));
            const numEmpleados = parseInt(row.getAttribute('data-num-empleados'));
            const tiempoTrabajoMeses = parseInt(row.getAttribute('data-tiempo-trabajo-meses'));

            totalEmpleadosGlobal += numEmpleados;

            totalMensualGeneral += resultados.costoTotalMensualPorEmpleado * numEmpleados;
            totalAnualGeneral += (resultados.costoTotalMensualPorEmpleado * tiempoTrabajoMeses) * numEmpleados;
            salarioBaseTotalGeneral += resultados.salarioBase * numEmpleados;
            bonosNoPrestacionalesTotalGeneral += resultados.bonosNoPrestacionales * numEmpleados;
        });

        const totalMensualGeneralElement = document.getElementById('totalMensualGeneral');
        const totalAnualGeneralElement = document.getElementById('totalAnualGeneral');

        if (totalMensualGeneralElement) totalMensualGeneralElement.textContent = formatCurrency(totalMensualGeneral);
        if (totalAnualGeneralElement) totalAnualGeneralElement.textContent = formatCurrency(totalAnualGeneral);

        if (totalMensualGeneralElement) totalMensualGeneralElement.setAttribute('data-total-mensual-global', totalMensualGeneral);
        if (totalMensualGeneralElement) totalMensualGeneralElement.setAttribute('data-salario-base-global', salarioBaseTotalGeneral);
        if (totalMensualGeneralElement) totalMensualGeneralElement.setAttribute('data-bonos-no-prestacionales-global', bonosNoPrestacionalesTotalGeneral);
        if (totalMensualGeneralElement) totalMensualGeneralElement.setAttribute('data-total-empleados-global', totalEmpleadosGlobal);
    }

    /**
     * Abre el modal de detalle de Carga Prestacional.
     */
    function abrirModal() {
        const detailModal = document.getElementById('detailModal');
        if (detailModal) detailModal.style.display = 'flex';
    }

    /**
     * Cierra el modal de detalle de Carga Prestacional.
     */
    function cerrarModal() {
        const detailModal = document.getElementById('detailModal');
        if (detailModal) detailModal.style.display = 'none';
    }

    /**
     * Muestra el detalle de carga prestacional para una fila específica.
     * @param {HTMLButtonElement} button - El botón "Ver Detalle" que fue clickeado.
     */
    function mostrarDetallePorFila(button) {
        const row = button.closest('tr');
        const resultados = JSON.parse(row.getAttribute('data-resultados'));
        const cargoNombre = row.getAttribute('data-cargo-nombre');
        const numEmpleados = parseInt(row.getAttribute('data-num-empleados'));

        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) modalTitle.textContent = `Detalle de Carga Prestacional para: ${cargoNombre} (1 empleado)`;
        populateDetailTable(resultados, false, numEmpleados);
        abrirModal();
    }

    /**
     * Muestra el detalle de carga prestacional agregado para todos los cargos.
     */
    function mostrarDetalleTotal() {
        let aggregatedResults = {
            salarioBase: 0,
            bonosNoPrestacionales: 0,
            valorAuxTransporte: 0,
            costoDotacionMensual: 0,
            ibc: 0,
            aporteSaludEmpleador: 0,
            aportePensionEmpleador: 0,
            aporteARL: 0,
            aporteCajaCompensacion: 0,
            aporteSENA: 0,
            aporteICBF: 0,
            provisionCesantias: 0,
            provisionInteresesCesantias: 0,
            provisionPrima: 0,
            provisionVacaciones: 0,
            costoTotalMensualPorEmpleado: 0,
            porcentajeCargaPrestacional: 0,
            esSalarioIntegral: false,
            tipoContrato: 'global',
            esPensionadoSi: false,
            exencionParafiscalesSi: false,
            estimatedRecargosExtras: 0, 
            estimatedHours: { 
                H_Ord_D: 0, H_Rec_Noc_Ord: 0, H_Ext_D: 0, H_Ext_Noc: 0,
                H_Ord_DomFest_D: 0, H_Ord_DomFest_N_Con_Rec: 0,
                H_Ext_DomFest_D: 0, H_Ext_DomFest_N: 0
            }
        };

        let totalEmpleadosGlobal = 0;

        document.querySelectorAll('#cargosTable tbody tr').forEach(row => {
            const resultados = JSON.parse(row.getAttribute('data-resultados'));
            const numEmpleados = parseInt(row.getAttribute('data-num-empleados'));

            totalEmpleadosGlobal += numEmpleados;

            aggregatedResults.salarioBase += resultados.salarioBase * numEmpleados;
            aggregatedResults.bonosNoPrestacionales += resultados.bonosNoPrestacionales * numEmpleados;
            aggregatedResults.valorAuxTransporte += resultados.valorAuxTransporte * numEmpleados;
            aggregatedResults.costoDotacionMensual += resultados.costoDotacionMensual * numEmpleados;

            aggregatedResults.aporteSaludEmpleador += resultados.aporteSaludEmpleador * numEmpleados;
            aggregatedResults.aportePensionEmpleador += resultados.aportePensionEmpleador * numEmpleados;
            aggregatedResults.aporteARL += resultados.aporteARL * numEmpleados;
            aggregatedResults.aporteCajaCompensacion += resultados.aporteCajaCompensacion * numEmpleados;
            aggregatedResults.aporteSENA += resultados.aporteSENA * numEmpleados;
            aggregatedResults.aporteICBF += resultados.aporteICBF * numEmpleados;

            aggregatedResults.provisionCesantias += resultados.provisionCesantias * numEmpleados;
            aggregatedResults.provisionInteresesCesantias += resultados.provisionInteresesCesantias * numEmpleados;
            aggregatedResults.provisionPrima += resultados.provisionPrima * numEmpleados;
            aggregatedResults.provisionVacaciones += resultados.provisionVacaciones * numEmpleados;

            aggregatedResults.costoTotalMensualPorEmpleado += resultados.costoTotalMensualPorEmpleado * numEmpleados;
            aggregatedResults.estimatedRecargosExtras += resultados.estimatedRecargosExtras * numEmpleados; 

            // Sumar horas estimadas para el total global
            aggregatedResults.estimatedHours.H_Ord_D += results.estimatedHours.H_Ord_D * numEmpleados;
            aggregatedResults.estimatedHours.H_Rec_Noc_Ord += results.estimatedHours.H_Rec_Noc_Ord * numEmpleados;
            aggregatedResults.estimatedHours.H_Ext_D += results.estimatedHours.H_Ext_D * numEmpleados;
            aggregatedResults.estimatedHours.H_Ext_Noc += results.estimatedHours.H_Ext_Noc * numEmpleados;
            aggregatedResults.estimatedHours.H_Ord_DomFest_D += results.estimatedHours.H_Ord_DomFest_D * numEmpleados;
            aggregatedResults.estimatedHours.H_Ord_DomFest_N_Con_Rec += results.estimatedHours.H_Ord_DomFest_N_Con_Rec * numEmpleados;
            aggregatedResults.estimatedHours.H_Ext_DomFest_D += results.estimatedHours.H_Ext_DomFest_D * numEmpleados;
            aggregatedResults.estimatedHours.H_Ext_DomFest_N += results.estimatedHours.H_Ext_DomFest_N * numEmpleados;
        });

        const baseParaPorcentajeGlobal = aggregatedResults.salarioBase + aggregatedResults.bonosNoPrestacionales + aggregatedResults.estimatedRecargosExtras;
        if (baseParaPorcentajeGlobal > 0) {
            const costoAdicionalGlobal = aggregatedResults.costoTotalMensualPorEmpleado - baseParaPorcentajeGlobal;
            aggregatedResults.porcentajeCargaPrestacional = costoAdicionalGlobal / baseParaPorcentajeGlobal;
        } else {
            aggregatedResults.porcentajeCargaPrestacional = 0;
        }

        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) modalTitle.textContent = `Detalle de Carga Prestacional Global (${totalEmpleadosGlobal} empleado${totalEmpleadosGlobal !== 1 ? 's' : ''})`;
        populateDetailTable(aggregatedResults, true, totalEmpleadosGlobal);
        abrirModal();
    }

    /**
     * Rellena la tabla de detalle en el modal con los resultados de cálculo de Carga Prestacional.
     * @param {object} results - Los resultados del cálculo para mostrar.
     * @param {boolean} [isGlobal=false] - Indica si se están mostrando resultados globales.
     * @param {number} numEmployeesForDisplay - El número de empleados a usar para la columna "Total Cargo".
     */
    function populateDetailTable(results, isGlobal = false, numEmployeesForDisplay = 1) {
        const detailTableBody = document.querySelector('#detailTable tbody');
        if (!detailTableBody) return;
        detailTableBody.innerHTML = '';

        const isServicio = results.tipoContrato === 'servicio';
        const isAprendizaje = results.tipoContrato === 'aprendizaje';
        const isIntegral = results.esSalarioIntegral;

        const appendRow = (concept, value, baseForPercentage = results.salarioBase) => {
            const row = detailTableBody.insertRow();
            let percentage = 0;
            if (baseForPercentage > 0) {
                percentage = value / baseForPercentage;
            }
            row.innerHTML = `
                <td>${concept}</td>
                <td class="currency">${formatCurrency(value)}</td>
                <td class="currency">${formatCurrency(value * numEmployeesForDisplay)}</td>
                <td>${formatPercentage(percentage)}</td>
            `;
        };

        appendRow('Salario Base', results.salarioBase, results.salarioBase);
        if (results.bonosNoPrestacionales > 0) appendRow('Bonos No Prestacionales', results.bonosNoPrestacionales, results.salarioBase);
        if (results.valorAuxTransporte > 0) appendRow('Auxilio de Transporte', results.valorAuxTransporte, results.salarioBase);
        if (results.costoDotacionMensual > 0) appendRow('Dotación Mensual (Provisionado)', results.costoDotacionMensual, results.salarioBase);

        if (results.estimatedHours && Object.keys(results.estimatedHours).length > 0) {
            const horasEstimadasHeader = detailTableBody.insertRow();
            horasEstimadasHeader.innerHTML = `<td colspan="4" style="font-weight: bold; background-color: #e9ecef;">Horas Estimadas Mensuales (por 1 Emp.)</td>`;
            const jornadaSemanalActual = parseInt(document.getElementById('jornada')?.value || 46) || 46; // Usar jornada de Nómina
            const valorHoraOrdinariaCarga = results.salarioBase / (jornadaSemanalActual * (52 / 12));

            if (results.estimatedHours.H_Ord_D > 0) appendRow('H. Ordinarias Diurnas Est.', results.estimatedHours.H_Ord_D * valorHoraOrdinariaCarga, results.salarioBase);
            if (results.estimatedHours.H_Rec_Noc_Ord > 0) appendRow('H. Recargo Nocturno Est.', results.estimatedHours.H_Rec_Noc_Ord * valorHoraOrdinariaCarga * RN_FACTOR, results.salarioBase);
            if (results.estimatedHours.H_Ext_D > 0) appendRow('H. Extra Diurnas Est.', results.estimatedHours.H_Ext_D * valorHoraOrdinariaCarga * (1 + HED_FACTOR), results.salarioBase);
            if (results.estimatedHours.H_Ext_Noc > 0) appendRow('H. Extra Nocturnas Est.', results.estimatedHours.H_Ext_Noc * valorHoraOrdinariaCarga * (1 + HEN_FACTOR), results.salarioBase);
            if (results.estimatedHours.H_Ord_DomFest_D > 0) appendRow('H. Ord. Dom./Fest. Diurna Est.', results.estimatedHours.H_Ord_DomFest_D * valorHoraOrdinariaCarga * (1 + HODF_FACTOR), results.salarioBase);
            if (results.estimatedHours.H_Ord_DomFest_N_Con_Rec > 0) appendRow('H. Ord. Dom./Fest. Nocturna Est.', results.estimatedHours.H_Ord_DomFest_N_Con_Rec * valorHoraOrdinariaCarga * (1 + HODF_FACTOR + RN_FACTOR), results.salarioBase);
            if (results.estimatedHours.H_Ext_DomFest_D > 0) appendRow('H. Extra Dom./Fest. Diurna Est.', results.estimatedHours.H_Ext_DomFest_D * valorHoraOrdinariaCarga * (1 + HODF_FACTOR + HED_FACTOR), results.salarioBase);
            if (results.estimatedHours.H_Ext_DomFest_N > 0) appendRow('H. Extra Dom./Fest. Nocturna Est.', results.estimatedHours.H_Ext_DomFest_N * valorHoraOrdinariaCarga * (1 + HODF_FACTOR + HEN_FACTOR), results.salarioBase);
            
            if (results.estimatedRecargosExtras > 0) {
                const totalRecargosExtrasRow = detailTableBody.insertRow();
                totalRecargosExtrasRow.innerHTML = `
                    <td style="font-weight: bold;">TOTAL Recargos/Extras Estimados</td>
                    <td class="currency" style="font-weight: bold;">${formatCurrency(results.estimatedRecargosExtras)}</td>
                    <td class="currency" style="font-weight: bold;">${formatCurrency(results.estimatedRecargosExtras * numEmployeesForDisplay)}</td>
                    <td></td>
                `;
            }
        }


        if (!isServicio) {
            appendRow('Aporte Salud (Empleador)', results.aporteSaludEmpleador, results.salarioBase);
            appendRow('Aporte Pensión (Empleador)', results.aportePensionEmpleador, results.salarioBase);
            appendRow('Aporte ARL', results.aporteARL, results.salarioBase);
        } else {
            appendRow('Aportes Seg. Social (Contratista - 40% IBC)', (results.ibc * 0.16) + (results.ibc * 0.125), results.salarioBase);
        }

        if (!isServicio && !isAprendizaje) {
            appendRow('Caja de Compensación', results.aporteCajaCompensacion, results.salarioBase);
            appendRow('SENA', results.aporteSENA, results.salarioBase);
            appendRow('ICBF', results.aporteICBF, results.salarioBase);
        }

        if (!isServicio && !isIntegral) {
            appendRow('Provisión Cesantías', results.provisionCesantias, results.salarioBase);
            appendRow('Provisión Intereses Cesantías', results.provisionInteresesCesantias, results.salarioBase);
            appendRow('Provisión Prima de Servicios', results.provisionPrima, results.salarioBase);
            appendRow('Provisión Vacaciones', results.provisionVacaciones, results.salarioBase);
        }

        if (!isServicio && !isAprendizaje && !isIntegral) { 
            const totalParafiscalesPerEmployee = results.aporteCajaCompensacion + results.aporteSENA + results.aporteICBF;
            const totalParafiscalesAndBonosPerEmployee = totalParafiscalesPerEmployee + results.bonosNoPrestacionales;
            const totalParafiscalesAndBonosForCargo = totalParafiscalesAndBonosPerEmployee * numEmployeesForDisplay;

            const row = detailTableBody.insertRow();
            row.innerHTML = `
                <td style="font-weight: bold;">Costo Parafiscales + Bonos No Prestacionales</td>
                <td class="currency" style="font-weight: bold;">${formatCurrency(totalParafiscalesAndBonosPerEmployee)}</td>
                <td class="currency" style="font-weight: bold;">${formatCurrency(totalParafiscalesAndBonosForCargo)}</td>
                <td></td>
            `;
        }

        const totalRow = detailTableBody.insertRow();
        totalRow.innerHTML = `
            <td style="font-weight: bold;">Costo Total Mensual ${isGlobal ? 'Global' : 'por Empleado'}</td>
            <td class="currency" style="font-weight: bold;">${formatCurrency(results.costoTotalMensualPorEmpleado / (isGlobal ? numEmployeesForDisplay : 1))}</td>
            <td class="currency" style="font-weight: bold;">${formatCurrency(results.costoTotalMensualPorEmpleado)}</td>
            <td></td>
        `;

        const totalCargaPercentageElement = document.getElementById('totalCargaPercentage');
        if (totalCargaPercentageElement) totalCargaPercentageElement.textContent = `Porcentaje de Carga Prestacional (adicional al Salario Base y Bonos No Prestacionales): ${formatPercentage(results.porcentajeCargaPrestacional)}`;
    }

    /**
     * Aplica restricciones a los campos de entrada de Carga Prestacional.
     */
    function applyFieldRestrictions() {
        const inputSalarioBase = document.getElementById('carga_inputSalarioBase');
        const salarioBase = parseFloat(inputSalarioBase?.value) || 0;

        const inputAuxTransporteSi = document.getElementById('carga_inputAuxTransporteSi');
        const inputAuxTransporteNo = document.getElementById('carga_inputAuxTransporteNo');
        const auxTransporteGroup = inputAuxTransporteSi?.closest('.input-group');

        const inputValorDotacionEntrega = document.getElementById('carga_inputValorDotacionEntrega');
        const dotacionGroup = inputValorDotacionEntrega?.closest('.input-group');

        const inputSalarioIntegralSi = document.getElementById('carga_inputSalarioIntegralSi');
        const isSalarioIntegral = inputSalarioIntegralSi?.checked || false;

        const inputTipoContrato = document.getElementById('carga_inputTipoContrato');
        const isContratoServicio = inputTipoContrato?.value === 'servicio';
        const isContratoAprendizaje = inputTipoContrato?.value === 'aprendizaje';

        const inputEsPensionadoSi = document.getElementById('carga_inputEsPensionadoSi');
        const inputEsPensionadoNo = document.getElementById('carga_inputEsPensionadoNo');

        const inputExencionParafiscalesSi = document.getElementById('carga_inputExencionParafiscalesSi');
        const inputExencionParafiscalesNo = document.getElementById('carga_inputExencionParafiscalesNo');

        const inputTipoRiesgoARL = document.getElementById('carga_inputTipoRiesgoARL');
        const tipoRiesgoARLGroup = inputTipoRiesgoARL?.closest('.input-group');

        const inputBonosNoPrestacionales = document.getElementById('carga_inputBonosNoPrestacionales');
        const bonosNoPrestacionalesGroup = inputBonosNoPrestacionales?.closest('.input-group');

        const inputTiempoTrabajoMeses = document.getElementById('carga_inputTiempoTrabajoMeses');
        const tiempoTrabajoMesesGroup = inputTiempoTrabajoMeses?.closest('.input-group');

        const cargaTipoTurno = document.getElementById('carga_tipoTurno');
        const cargaHorasPorDiaTurnoContainer = document.getElementById('carga_horasPorDiaTurnoContainer');
        const cargaDescansoRegularContainer = document.getElementById('carga_descansoRegularContainer');
        const cargaHoraEntrada = document.getElementById('carga_horaEntrada');
        const cargaHoraSalida = document.getElementById('carga_horaSalida');
        const cargaHorasDescansoDiario = document.getElementById('carga_horasDescansoDiario');

        if (isSalarioIntegral || isContratoServicio || isContratoAprendizaje) {
            if (inputAuxTransporteSi) inputAuxTransporteSi.disabled = true;
            if (inputAuxTransporteNo) inputAuxTransporteNo.disabled = true;
            if (inputAuxTransporteNo) inputAuxTransporteNo.checked = true;
            if (auxTransporteGroup) auxTransporteGroup.classList.add('disabled-input');

            if (inputValorDotacionEntrega) inputValorDotacionEntrega.disabled = true;
            if (inputValorDotacionEntrega) inputValorDotacionEntrega.value = '0';
            if (dotacionGroup) dotacionGroup.classList.add('disabled-input');
        } else {
            if (inputAuxTransporteSi) inputAuxTransporteSi.disabled = false;
            if (inputAuxTransporteNo) inputAuxTransporteNo.disabled = false;
            if (auxTransporteGroup) auxTransporteGroup.classList.remove('disabled-input');

            if (inputValorDotacionEntrega) inputValorDotacionEntrega.disabled = false;
            if (dotacionGroup) dotacionGroup.classList.remove('disabled-input');

            if (salarioBase > (2 * SMMLV)) {
                if (inputAuxTransporteSi) inputAuxTransporteSi.disabled = true;
                if (inputAuxTransporteNo) inputAuxTransporteNo.checked = true;
                if (inputValorDotacionEntrega) inputValorDotacionEntrega.disabled = true;
                if (inputValorDotacionEntrega) inputValorDotacionEntrega.value = '0';
            }
        }

        if (isSalarioIntegral) {
            if (inputBonosNoPrestacionales) inputBonosNoPrestacionales.disabled = true;
            if (inputBonosNoPrestacionales) inputBonosNoPrestacionales.value = '0';
            if (bonosNoPrestacionalesGroup) bonosNoPrestacionalesGroup.classList.add('disabled-input');

            if (inputTiempoTrabajoMeses) inputTiempoTrabajoMeses.disabled = true;
            if (inputTiempoTrabajoMeses) inputTiempoTrabajoMeses.value = '12';
            if (tiempoTrabajoMesesGroup) tiempoTrabajoMesesGroup.classList.add('disabled-input');

            if (inputTipoContrato) inputTipoContrato.value = 'indefinido';
            if (inputTipoContrato) inputTipoContrato.disabled = true;

            if (inputEsPensionadoSi) inputEsPensionadoSi.disabled = true;
            if (inputEsPensionadoNo) inputEsPensionadoNo.disabled = true;
            if (inputExencionParafiscalesSi) inputExencionParafiscalesSi.disabled = true;
            if (inputExencionParafiscalesNo) inputExencionParafiscalesNo.disabled = true;
            if (document.querySelector('input[name="carga_inputExencionParafiscales"][value="no"]')) document.querySelector('input[name="carga_inputExencionParafiscales"][value="no"]').checked = true;
            
            if (inputTipoRiesgoARL) inputTipoRiesgoARL.disabled = false;
            if (tipoRiesgoARLGroup) tipoRiesgoARLGroup.classList.remove('disabled-input');

        } else {
            if (inputBonosNoPrestacionales) inputBonosNoPrestacionales.disabled = false;
            if (bonosNoPrestacionalesGroup) bonosNoPrestacionalesGroup.classList.remove('disabled-input');
            if (inputTiempoTrabajoMeses) inputTiempoTrabajoMeses.disabled = false;
            if (tiempoTrabajoMesesGroup) tiempoTrabajoMesesGroup.classList.remove('disabled-input');
            if (inputTipoContrato) inputTipoContrato.disabled = false;
            if (inputEsPensionadoSi) inputEsPensionadoSi.disabled = false;
            if (inputEsPensionadoNo) inputEsPensionadoNo.disabled = false;
            if (inputExencionParafiscalesSi) inputExencionParafiscalesSi.disabled = false;
            if (inputExencionParafiscalesNo) inputExencionParafiscalesNo.disabled = false;
        }

        if (isContratoServicio) {
            if (inputEsPensionadoSi) inputEsPensionadoSi.disabled = true;
            if (inputEsPensionadoNo) inputEsPensionadoNo.disabled = true;
            if (inputExencionParafiscalesSi) inputExencionParafiscalesSi.disabled = true;
            if (document.querySelector('input[name="carga_inputExencionParafiscales"][value="si"]')) document.querySelector('input[name="carga_inputExencionParafiscales"][value="si"]').checked = true;
            if (inputExencionParafiscalesNo) inputExencionParafiscalesNo.disabled = true;
            
            if (inputTipoRiesgoARL) inputTipoRiesgoARL.disabled = true;
            if (tipoRiesgoARLGroup) tipoRiesgoARLGroup.classList.add('disabled-input');

        } else if (!isSalarioIntegral) {
             if (inputEsPensionadoSi) inputEsPensionadoSi.disabled = false;
             if (inputEsPensionadoNo) inputEsPensionadoNo.disabled = false;
             if (inputExencionParafiscalesSi) inputExencionParafiscalesSi.disabled = false;
             if (inputExencionParafiscalesNo) inputExencionParafiscalesNo.disabled = false;
             if (inputTipoRiesgoARL) inputTipoRiesgoARL.disabled = false;
             if (tipoRiesgoARLGroup) tipoRiesgoARLGroup.classList.remove('disabled-input');
        }

        if (isContratoAprendizaje) {
            if (inputEsPensionadoSi) inputEsPensionadoSi.disabled = true;
            if (inputEsPensionadoNo) inputEsPensionadoNo.disabled = true;
            if (inputExencionParafiscalesSi) inputExencionParafiscalesSi.disabled = true;
            if (document.querySelector('input[name="carga_inputExencionParafiscales"][value="si"]')) document.querySelector('input[name="carga_inputExencionParafiscales"][value="si"]').checked = true;
            if (inputExencionParafiscalesNo) inputExencionParafiscalesNo.disabled = true;
            
            if (inputTipoRiesgoARL) inputTipoRiesgoARL.disabled = false;
            if (tipoRiesgoARLGroup) tipoRiesgoARLGroup.classList.remove('disabled-input');

        } else if (!isSalarioIntegral && !isContratoServicio) {
             if (inputEsPensionadoSi) inputEsPensionadoSi.disabled = false;
             if (inputEsPensionadoNo) inputEsPensionadoNo.disabled = false;
             if (inputExencionParafiscalesSi) inputExencionParafiscalesSi.disabled = false;
             if (inputExencionParafiscalesNo) inputExencionParafiscalesNo.disabled = false;
        }

        if (isSalarioIntegral || isContratoServicio) {
            if (cargaTipoTurno) cargaTipoTurno.disabled = true;
            if (cargaHorasPorDiaTurnoContainer) cargaHorasPorDiaTurnoContainer.style.display = 'none';
            if (cargaDescansoRegularContainer) cargaDescansoRegularContainer.style.display = 'none';
            if (cargaHoraEntrada) cargaHoraEntrada.disabled = true;
            if (cargaHoraSalida) cargaHoraSalida.disabled = true;
            if (cargaHorasDescansoDiario) cargaHorasDescansoDiario.disabled = true;
        } else {
            if (cargaTipoTurno) cargaTipoTurno.disabled = false;
            if (cargaHoraEntrada) cargaHoraEntrada.disabled = false;
            if (cargaHoraSalida) cargaHoraSalida.disabled = false;
            if (cargaHorasDescansoDiario) cargaHorasDescansoDiario.disabled = false;
            toggleCargaHorasPorDiaTurnoInput(); 
        }
    }

    /**
     * Limpia los campos del formulario de entrada de Carga Prestacional y re-aplica las restricciones.
     */
    function limpiarFormularioCargaPrestacional() {
        if (document.getElementById('carga_inputCargoNombre')) document.getElementById('carga_inputCargoNombre').value = '';
        if (document.getElementById('carga_inputNumEmpleados')) document.getElementById('carga_inputNumEmpleados').value = '1';
        if (document.getElementById('carga_inputSalarioBase')) document.getElementById('carga_inputSalarioBase').value = '1500000';
        if (document.getElementById('carga_inputSalarioIntegralNo')) document.getElementById('carga_inputSalarioIntegralNo').checked = true;
        if (document.getElementById('carga_inputBonosNoPrestacionales')) document.getElementById('carga_inputBonosNoPrestacionales').value = '0';
        if (document.getElementById('carga_inputAuxTransporteSi')) document.getElementById('carga_inputAuxTransporteSi').checked = true;
        if (document.getElementById('carga_inputValorDotacionEntrega')) document.getElementById('carga_inputValorDotacionEntrega').value = '0';
        if (document.getElementById('carga_inputTiempoTrabajoMeses')) document.getElementById('carga_inputTiempoTrabajoMeses').value = '12';
        if (document.getElementById('carga_inputTipoContrato')) document.getElementById('carga_inputTipoContrato').value = 'indefinido';
        if (document.getElementById('carga_inputEsPensionadoNo')) document.getElementById('carga_inputEsPensionadoNo').checked = true;
        if (document.getElementById('carga_inputExencionParafiscalesNo')) document.getElementById('carga_inputExencionParafiscalesNo').checked = true;
        if (document.getElementById('carga_inputTipoRiesgoARL')) document.getElementById('carga_inputTipoRiesgoARL').value = '3';
        // Limpiar campos de turno
        if (document.getElementById('carga_tipoTurno')) document.getElementById('carga_tipoTurno').value = 'regular';
        if (document.getElementById('carga_horasPorDiaTurno')) document.getElementById('carga_horasPorDiaTurno').value = '10'; 
        if (document.getElementById('carga_descansoRegular')) document.getElementById('carga_descansoRegular').value = 'domingo';
        if (document.getElementById('carga_horaEntrada')) document.getElementById('carga_horaEntrada').value = '07:00';
        if (document.getElementById('carga_horaSalida')) document.getElementById('carga_horaSalida').value = '16:00';
        if (document.getElementById('carga_horasDescansoDiario')) document.getElementById('carga_horasDescansoDiario').value = '1';

        applyFieldRestrictions();
    }

    /**
     * Maneja la visibilidad del input de horas por día de turno en la sección de Carga Prestacional.
     */
    function toggleCargaHorasPorDiaTurnoInput() {
        const tipoTurno = document.getElementById('carga_tipoTurno')?.value;
        const horasPorDiaTurnoContainer = document.getElementById('carga_horasPorDiaTurnoContainer');
        const descansoRegularContainer = document.getElementById('carga_descansoRegularContainer');

        if (horasPorDiaTurnoContainer && descansoRegularContainer) {
            if (tipoTurno === '4x3' || tipoTurno === '5x2' || tipoTurno === '4x3_rotativo') {
                horasPorDiaTurnoContainer.style.display = 'block';
                descansoRegularContainer.style.display = 'none'; // Ocultar si es turno rotativo
                if (document.getElementById('carga_horasPorDiaTurno')) {
                    if (tipoTurno === '4x3_rotativo') {
                        document.getElementById('carga_horasPorDiaTurno').value = '10.5';
                        if (document.getElementById('carga_horasDescansoDiario')) document.getElementById('carga_horasDescansoDiario').value = '1.5';
                    } else {
                        document.getElementById('carga_horasPorDiaTurno').value = (tipoTurno === '4x3') ? '10' : '8';
                    }
                }
            } else {
                horasPorDiaTurnoContainer.style.display = 'none';
                descansoRegularContainer.style.display = 'block'; // Mostrar si es turno regular
                if (document.getElementById('carga_horasDescansoDiario') && document.getElementById('carga_horasDescansoDiario').value === '1.5') {
                    document.getElementById('carga_horasDescansoDiario').value = '1';
                }
            }
        }
    }


    // --- Lógica de la Calculadora de Liquidación ---
    /**
     * Calcula la liquidación de contrato.
     */
    function calcularLiquidacion() {
        if (document.getElementById('liquidacionResultados')) document.getElementById('liquidacionResultados').style.display = 'none';
        if (liquidacionReceiptSectionWrapper) liquidacionReceiptSectionWrapper.style.display = 'none';
        document.querySelectorAll('.print-target').forEach(el => el.classList.remove('print-target')); 

        const nombreTrabajador = document.getElementById('liq_nombreTrabajador')?.value || 'N/A';
        const cedulaTrabajador = document.getElementById('liq_cedulaTrabajador')?.value || 'N/A';
        const fechaIngresoStr = document.getElementById('liq_fechaIngreso')?.value;
        const fechaRetiroStr = document.getElementById('liq_fechaRetiro')?.value;
        const salarioBase = parseFloat(document.getElementById('liq_salarioBase')?.value || 0);
        const esSalarioIntegral = document.getElementById('liq_esSalarioIntegralSi')?.checked || false;
        const aplicaAuxTransporte = document.getElementById('liq_aplicaAuxTransporteSi')?.checked || false;
        const diasVacacionesPendientes = parseFloat(document.getElementById('liq_diasVacacionesPendientes')?.value || 0);
        const diasIncapacidad = parseFloat(document.getElementById('liq_diasIncapacidad')?.value || 0);
        const diasLicenciaNoRemunerada = parseFloat(document.getElementById('liq_diasLicenciaNoRemunerada')?.value || 0);
        const prestamosEmpresa = parseFloat(document.getElementById('liq_prestamosEmpresa')?.value || 0);
        const aportesVoluntariosPension = parseFloat(document.getElementById('liq_aportesVoluntariosPension')?.value || 0);
        const cesantiasConsignadas = parseFloat(document.getElementById('liq_cesantiasConsignadas')?.value || 0);
        const interesesCesantiasPagados = parseFloat(document.getElementById('liq_interesesCesantiasPagados')?.value || 0);
        const primasPagadas = parseFloat(document.getElementById('liq_primasPagadas')?.value || 0);

        const fechaIngreso = parseDateString(fechaIngresoStr);
        const fechaRetiro = parseDateString(fechaRetiroStr);

        if (!fechaIngreso || !fechaRetiro || fechaIngreso > fechaRetiro || salarioBase <= 0) {
            console.error('Por favor, ingrese fechas de ingreso y retiro válidas (ingreso no puede ser posterior a retiro) y un salario base mayor a cero.');
            return;
        }

        // calculateDaysWorked360 ya ajusta el día 31 a 30 para liquidaciones.
        const diasTrabajadosTotales = calculateDaysWorked360(fechaIngreso, fechaRetiro); 
        const diasParaPrestaciones = Math.max(0, diasTrabajadosTotales - diasIncapacidad - diasLicenciaNoRemunerada);

        let auxilioTransporteLiquidacion = 0;
        if (aplicaAuxTransporte && salarioBase <= (2 * SMMLV)) {
            auxilioTransporteLiquidacion = AUX_TRANSPORTE_BASE;
        }

        let salarioPendiente = 0;
        const salarioYaPagado = document.getElementById('liq_salarioYaPagadoCheck')?.checked || false;

        if (!salarioYaPagado) {
            // Para el salario pendiente del mes de retiro, se usan los días reales del mes.
            // Si el día de retiro es 31, se cuenta 31 días.
            const realDaysInMonthOfRetirement = new Date(fechaRetiro.getFullYear(), fechaRetiro.getMonth() + 1, 0).getDate();
            const daysWorkedInMonthOfRetirement = fechaRetiro.getDate();
            salarioPendiente = (salarioBase / realDaysInMonthOfRetirement) * daysWorkedInMonthOfRetirement;
        }


        let totalCesantias = 0;
        let totalInteresesCesantias = 0;
        let totalPrimaServicios = 0;
        let totalVacacionesCompensadas = 0;

        if (!esSalarioIntegral) {
            const basePrestaciones = salarioBase + auxilioTransporteLiquidacion;

            totalCesantias = (basePrestaciones * diasParaPrestaciones) / 360;
            totalCesantias = Math.max(0, totalCesantias - cesantiasConsignadas);

            totalInteresesCesantias = (totalCesantias * 0.12 * diasParaPrestaciones) / 360;
            totalInteresesCesantias = Math.max(0, totalInteresesCesantias - interesesCesantiasPagados);

            // --- INICIO DE LA CORRECCIÓN DE LA FÓRMULA DE PRIMA ---
            let inicioSemestrePrima;
            // Determina el inicio del semestre actual para el cálculo de la prima
            if (fechaRetiro.getMonth() < 6) { // Si la fecha de retiro es de enero a junio
                inicioSemestrePrima = new Date(fechaRetiro.getFullYear(), 0, 1); // Inicio del 1er semestre (Enero 1)
            } else { // Si la fecha de retiro es de julio a diciembre
                inicioSemestrePrima = new Date(fechaRetiro.getFullYear(), 6, 1); // Inicio del 2do semestre (Julio 1)
            }
            
            // Ajusta el inicio del semestre si la fecha de ingreso es posterior
            if (fechaIngreso > inicioSemestrePrima) {
                inicioSemestrePrima = fechaIngreso;
            }
            
            // Calcula los días trabajados en el semestre actual para la prima
            // calculateDaysWorked360 ya ajusta el día 31 a 30 para liquidaciones.
            const diasTrabajadosEnSemestreParaPrima = calculateDaysWorked360(inicioSemestrePrima, fechaRetiro);
            
            // Fórmula corregida: (Base Mensual * Días Trabajados en el Semestre) / 360
            // El 360 representa los días de un año laboral, ya que la prima es un mes de salario por año.
            totalPrimaServicios = (basePrestaciones * diasTrabajadosEnSemestreParaPrima) / 360;
            totalPrimaServicios = Math.max(0, totalPrimaServicios - primasPagadas);
            // --- FIN DE LA CORRECCIÓN DE LA FÓRMULA DE PRIMA ---

            const valorVacacionesCausadas = (salarioBase * diasParaPrestaciones) / 720; // 360 * 2 = 720
            const valorDiasVacacionesPendientes = (salarioBase / 30) * diasVacacionesPendientes;
            totalVacacionesCompensadas = valorVacacionesCausadas + valorDiasVacacionesPendientes;
        } else {
            totalCesantias = 0;
            totalInteresesCesantias = 0;
            totalPrimaServicios = 0; // Si es salario integral, no hay prima separada
            totalVacacionesCompensadas = 0;
        }

        const totalDevengado = salarioPendiente + totalCesantias + totalInteresesCesantias + totalPrimaServicios + totalVacacionesCompensadas;
        const totalDeducciones = prestamosEmpresa + aportesVoluntariosPension;
        const netoAPagar = totalDevengado - totalDeducciones;
        console.log(netoAPagar);

        document.getElementById('liq_diasTotalesLiquidacion').textContent = `${diasTrabajadosTotales} días`;
        document.getElementById('liq_salarioPendiente').textContent = formatCurrency(salarioPendiente);
        document.getElementById('liq_cesantias').textContent = formatCurrency(totalCesantias);
        document.getElementById('liq_interesesCesantias').textContent = formatCurrency(totalInteresesCesantias);
        document.getElementById('liq_primaServicios').textContent = formatCurrency(totalPrimaServicios);
        document.getElementById('liq_vacacionesCompensadas').textContent = formatCurrency(totalVacacionesCompensadas);
        document.getElementById('liq_totalDevengado').textContent = formatCurrency(totalDevengado);
        document.getElementById('liq_totalDeducciones').textContent = formatCurrency(totalDeducciones);
        document.getElementById('liq_netoAPagar').textContent = formatCurrency(netoAPagar);
        document.getElementById('liq_netoAPagar2').textContent = formatCurrency(netoAPagar);

        document.getElementById('liquidacionResultados').style.display = 'block';
        document.getElementById('liquidacionResultados').scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Actualizar sección del recibo de liquidación
        const liq_receiptFechaEmision = document.getElementById('liq_receiptFechaEmision');
        const liq_receiptNombre = document.getElementById('liq_receiptNombre');
        const liq_receiptCedula = document.getElementById('liq_receiptCedula');
        const liq_receiptSalarioBase = document.getElementById('liq_receiptSalarioBase');
        const liq_receiptPeriodoLaborado = document.getElementById('liq_receiptPeriodoLaborado');
        const liq_receiptDiasTotales = document.getElementById('liq_receiptDiasTotales');
        const liq_receiptSalarioPendiente = document.getElementById('liq_receiptSalarioPendiente');
        const liq_receiptCesantias = document.getElementById('liq_receiptCesantias');
        const liq_receiptInteresesCesantias = document.getElementById('liq_receiptInteresesCesantias');
        const liq_receiptPrimaServicios = document.getElementById('liq_receiptPrimaServicios');
        const liq_receiptVacacionesCompensadas = document.getElementById('liq_receiptVacacionesCompensadas');
        const liq_receiptTotalDevengado = document.getElementById('liq_receiptTotalDevengado');
        const liq_receiptPrestamosEmpresa = document.getElementById('liq_receiptPrestamosEmpresa');
        const liq_receiptAportesVoluntariosPension = document.getElementById('liq_receiptAportesVoluntariosPension');
        const liq_receiptTotalDeducciones = document.getElementById('liq_receiptTotalDeducciones');
        const liq_receiptNetoAPagar = document.getElementById('liq_netoAPagar');
        const liq_receiptNetoAPagar2 = document.getElementById('liq_netoAPagar2');

        if (liq_receiptFechaEmision) liq_receiptFechaEmision.textContent = new Date().toLocaleDateString('es-CO');
        if (liq_receiptNombre) liq_receiptNombre.textContent = nombreTrabajador;
        if (liq_receiptCedula) liq_receiptCedula.textContent = cedulaTrabajador;
        if (liq_receiptSalarioBase) liq_receiptSalarioBase.textContent = formatCurrency(salarioBase);
        if (liq_receiptPeriodoLaborado) liq_receiptPeriodoLaborado.textContent = `${fechaIngresoStr} - ${fechaRetiroStr}`;
        if (liq_receiptDiasTotales) liq_receiptDiasTotales.textContent = `${diasTrabajadosTotales} días`;
        if (liq_receiptSalarioPendiente) liq_receiptSalarioPendiente.textContent = formatCurrency(salarioPendiente);
        if (liq_receiptCesantias) liq_receiptCesantias.textContent = formatCurrency(totalCesantias);
        if (liq_receiptInteresesCesantias) liq_receiptInteresesCesantias.textContent = formatCurrency(totalInteresesCesantias);
        if (liq_receiptPrimaServicios) liq_receiptPrimaServicios.textContent = formatCurrency(totalPrimaServicios);
        if (liq_receiptVacacionesCompensadas) liq_receiptVacacionesCompensadas.textContent = formatCurrency(totalVacacionesCompensadas);
        if (liq_receiptTotalDevengado) liq_receiptTotalDevengado.textContent = formatCurrency(totalDevengado);
        if (liq_receiptPrestamosEmpresa) liq_receiptPrestamosEmpresa.textContent = formatCurrency(prestamosEmpresa);
        if (liq_receiptAportesVoluntariosPension) liq_receiptAportesVoluntariosPension.textContent = formatCurrency(aportesVoluntariosPension);
        if (liq_receiptTotalDeducciones) liq_receiptTotalDeducciones.textContent = formatCurrency(totalDeducciones);
        if (liq_receiptNetoAPagar) liq_receiptNetoAPagar.textContent = formatCurrency(netoAPagar);
        if (liq_receiptNetoAPagar2) liq_receiptNetoAPagar2.textContent = formatCurrency(netoAPagar);
    }

    /**
     * Aplica restricciones a los campos de entrada de Liquidación.
     */
    function applyLiquidacionFieldRestrictions() {
        const salarioBaseInput = document.getElementById('liq_salarioBase');
        const salarioBase = parseFloat(salarioBaseInput?.value || 0);

        const aplicaAuxTransporteSi = document.getElementById('liq_aplicaAuxTransporteSi');
        const aplicaAuxTransporteNo = document.getElementById('liq_aplicaAuxTransporteNo');

        const esSalarioIntegralSi = document.getElementById('liq_esSalarioIntegralSi');
        const esSalarioIntegral = esSalarioIntegralSi?.checked || false;

        // Si es salario integral, el auxilio de transporte no aplica
        if (esSalarioIntegral) {
            if (aplicaAuxTransporteSi) aplicaAuxTransporteSi.disabled = true;
            if (aplicaAuxTransporteNo) aplicaAuxTransporteNo.disabled = true;
            if (aplicaAuxTransporteNo) aplicaAuxTransporteNo.checked = true; // Desactivar auxilio
        } else {
            if (aplicaAuxTransporteSi) aplicaAuxTransporteSi.disabled = false;
            if (aplicaAuxTransporteNo) aplicaAuxTransporteNo.disabled = false;
            // Si el salario base es mayor a 2 SMMLV, el auxilio de transporte no aplica legalmente
            if (salarioBase > (2 * SMMLV)) {
                if (aplicaAuxTransporteSi) aplicaAuxTransporteSi.disabled = true;
                if (aplicaAuxTransporteNo) aplicaAuxTransporteNo.checked = true; // Desactivar auxilio
            }
        }
    }

    /**
     * Imprime la liquidación detallada.
     */
    function printLiquidacionDetallada() {
        calcularLiquidacion();
        document.body.classList.add('print-mode-liquidacion');
        window.print();
        document.body.classList.remove('print-mode-liquidacion');
    }

    /**
     * Muestra el recibo de liquidación para imprimir.
     */
    function mostrarReciboLiquidacionParaImprimir() {
        calcularLiquidacion();
        if (document.getElementById('liquidacionResultados')) document.getElementById('liquidacionResultados').style.display = 'none';
        if (liquidacionReceiptSectionWrapper) liquidacionReceiptSectionWrapper.style.display = 'block';
        document.body.classList.add('print-mode-liquidacion-receipt');
        if (liquidacionReceiptSectionWrapper) liquidacionReceiptSectionWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /**
     * Imprime el recibo de liquidación.
     */
    function printReciboLiquidacion() {
        window.print();
    }

    /**
     * Vuelve a la sección de resultados de liquidación desde el recibo.
     */
    function volverAResultadosLiquidacion() {
        if (liquidacionReceiptSectionWrapper) liquidacionReceiptSectionWrapper.style.display = 'none';
        document.body.classList.remove('print-mode-liquidacion-receipt');
        if (document.getElementById('liquidacionResultados')) document.getElementById('liquidacionResultados').style.display = 'block';
        if (document.getElementById('liquidacionResultados')) document.getElementById('liquidacionResultados').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }


    // --- Event Listeners Globales ---
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Nómina Tab Listeners
        const nombreEmpresaInput = document.getElementById('nombreEmpresa'); 
        const nombreInput = document.getElementById('nombre');
        const cedulaInput = document.getElementById('cedula');
        const salarioInput = document.getElementById('salario');
        const transporteInput = document.getElementById('transporte');
        const jornadaSelect = document.getElementById('jornada');
        const tipoTurnoSelect = document.getElementById('tipoTurno');
        const horasPorDiaTurnoInput = document.getElementById('horasPorDiaTurno');
        const reembolsoInput = document.getElementById('reembolso');
        const descuentoInput = document.getElementById('descuento');
        const horaEntradaInput = document.getElementById('horaEntrada');
        const horaSalidaInput = document.getElementById('horaSalida');
        const horasDescansoPeriodoInput = document.getElementById('horasDescansoPeriodo');
        const fechaInicioInput = document.getElementById('fechaInicio');
        const fechaFinInput = document.getElementById('fechaFin');
        const agregarDiaBtn = document.getElementById('agregarDia');
        const prellenarBtn = document.getElementById('prellenar');
        const calcularBtn = document.getElementById('calcular');
        const imprimirBtn = document.getElementById('imprimir');
        const mostrarImprimirReciboBtn = document.getElementById('mostrarImprimirReciboBtn');
        const imprimirReciboFinalBtn = document.getElementById('imprimirReciboFinalBtn');
        const volverAResultadosBtn = document.getElementById('volverAResultadosBtn');
        const guardarEnSheetsBtn = document.getElementById('guardarEnSheets');

        // Carga Prestacional Tab Listeners
        const agregarCargoBtn = document.getElementById('agregarCargoBtn');
        const limpiarFormCargaBtn = document.getElementById('limpiarFormCargaBtn');
        const mostrarDetalleTotalBtn = document.getElementById('mostrarDetalleTotalBtn');
        const imprimirCargaBtn = document.getElementById('imprimirCargaBtn');
        const detailModal = document.getElementById('detailModal');
        const closeModalButton = document.querySelector('#detailModal .close-button');
        const cargaSalarioBaseInput = document.getElementById('carga_inputSalarioBase');
        const cargaSalarioIntegralSi = document.getElementById('carga_inputSalarioIntegralSi');
        const cargaSalarioIntegralNo = document.getElementById('carga_inputSalarioIntegralNo');
        const cargaAuxTransporteSi = document.getElementById('carga_inputAuxTransporteSi');
        const cargaAuxTransporteNo = document.getElementById('carga_inputAuxTransporteNo');
        const cargaValorDotacionEntrega = document.getElementById('carga_inputValorDotacionEntrega');
        const cargaTipoContrato = document.getElementById('carga_inputTipoContrato');
        const cargaEsPensionadoSi = document.getElementById('carga_inputEsPensionadoSi');
        const cargaEsPensionadoNo = document.getElementById('carga_inputEsPensionadoNo');
        const cargaExencionParafiscalesSi = document.getElementById('carga_inputExencionParafiscalesSi');
        const cargaExencionParafiscalesNo = document.getElementById('carga_inputExencionParafiscalesNo');
        const cargaTipoRiesgoARL = document.getElementById('carga_inputTipoRiesgoARL');
        const cargaTipoTurno = document.getElementById('carga_tipoTurno');
        const cargaHorasPorDiaTurno = document.getElementById('carga_horasPorDiaTurno');
        const cargaDescansoRegular = document.getElementById('carga_descansoRegular');
        const cargaHoraEntrada = document.getElementById('carga_horaEntrada');
        const cargaHoraSalida = document.getElementById('carga_horaSalida');
        const cargaHorasDescansoDiario = document.getElementById('carga_horasDescansoDiario');


        // Liquidación Tab Listeners
        const calcularLiquidacionBtn = document.getElementById('calcularLiquidacionBtn');
        const liq_salarioBase = document.getElementById('liq_salarioBase');
        const liq_esSalarioIntegralSi = document.getElementById('liq_esSalarioIntegralSi');
        const liq_esSalarioIntegralNo = document.getElementById('liq_esSalarioIntegralNo');
        const liq_aplicaAuxTransporteSi = document.getElementById('liq_aplicaAuxTransporteSi');
        const liq_aplicaAuxTransporteNo = document.getElementById('liq_aplicaAuxTransporteNo');
        const liq_salarioYaPagadoCheck = document.getElementById('liq_salarioYaPagadoCheck');
        const mostrarImprimirReciboLiquidacionBtn = document.getElementById('mostrarImprimirReciboLiquidacionBtn');
        const imprimirLiquidacionDetalladaBtn = document.getElementById('imprimirLiquidacionDetalladaBtn');
        const volverAResultadosLiquidacionBtn = document.getElementById('volverAResultadosLiquidacionBtn');
        const imprimirReciboLiquidacionFinalBtn = document.getElementById('imprimirReciboLiquidacionFinalBtn');
        const liquidacionReceiptSectionWrapper = document.getElementById('liquidacionReceiptSectionWrapper');


        // --- Nómina Tab Event Listeners ---
        if (agregarDiaBtn) agregarDiaBtn.addEventListener('click', () => agregarDia(null, { isManualAdd: true, entrada: horaEntradaInput.value, salida: horaSalidaInput.value }));
        if (prellenarBtn) prellenarBtn.addEventListener('click', prellenarHorarios);
        if (calcularBtn) calcularBtn.addEventListener('click', calcularNomina);
        if (imprimirBtn) imprimirBtn.addEventListener('click', printNomina);
        if (mostrarImprimirReciboBtn) mostrarImprimirReciboBtn.addEventListener('click', mostrarReciboParaImprimir);
        if (imprimirReciboFinalBtn) imprimirReciboFinalBtn.addEventListener('click', printRecibo);
        if (volverAResultadosBtn) volverAResultadosBtn.addEventListener('click', volverAResultados);
        if (guardarEnSheetsBtn) guardarEnSheetsBtn.addEventListener('click', guardarDatosEnSheets);

        // Inputs que disparan el cálculo de nómina al cambiar
        const inputsNomina = [
            salarioInput, transporteInput, jornadaSelect, horasDescansoPeriodoInput,
            reembolsoInput, descuentoInput, tipoTurnoSelect, horasPorDiaTurnoInput,
            horaEntradaInput, horaSalidaInput, fechaInicioInput, fechaFinInput
        ];
        inputsNomina.forEach(input => {
            if (input) input.addEventListener('change', calcularNomina);
            if (input) input.addEventListener('input', calcularNomina); // For number inputs
        });
        if (tipoTurnoSelect) tipoTurnoSelect.addEventListener('change', toggleHorasPorDiaTurnoInput);


        // --- Carga Prestacional Tab Event Listeners ---
        if (agregarCargoBtn) agregarCargoBtn.addEventListener('click', agregarCargo);
        if (limpiarFormCargaBtn) limpiarFormCargaBtn.addEventListener('click', limpiarFormularioCargaPrestacional);
        if (mostrarDetalleTotalBtn) mostrarDetalleTotalBtn.addEventListener('click', mostrarDetalleTotal);
        if (imprimirCargaBtn) imprimirCargaBtn.addEventListener('click', () => {
            document.body.classList.add('print-mode-carga');
            window.print();
            document.body.classList.remove('print-mode-carga');
        });
        if (closeModalButton) closeModalButton.addEventListener('click', cerrarModal);
        if (detailModal) detailModal.addEventListener('click', (event) => {
            if (event.target === detailModal) cerrarModal();
        });

        // Inputs que disparan restricciones y toggle en Carga Prestacional
        const cargaInputs = [
            cargaSalarioBaseInput, cargaSalarioIntegralSi, cargaSalarioIntegralNo,
            cargaAuxTransporteSi, cargaAuxTransporteNo, cargaValorDotacionEntrega,
            cargaTipoContrato, cargaEsPensionadoSi, cargaEsPensionadoNo,
            cargaExencionParafiscalesSi, cargaExencionParafiscalesNo, cargaTipoRiesgoARL,
            cargaTipoTurno, cargaHorasPorDiaTurno, cargaDescansoRegular, cargaHoraEntrada, cargaHoraSalida, cargaHorasDescansoDiario
        ];
        cargaInputs.forEach(input => {
            if (input) input.addEventListener('change', applyFieldRestrictions);
            if (input) input.addEventListener('input', applyFieldRestrictions);
        });
        if (cargaTipoTurno) cargaTipoTurno.addEventListener('change', toggleCargaHorasPorDiaTurnoInput);


        // --- Liquidación Tab Event Listeners ---
        if (calcularLiquidacionBtn) calcularLiquidacionBtn.addEventListener('click', calcularLiquidacion);
        if (liq_salarioBase) liq_salarioBase.addEventListener('input', applyLiquidacionFieldRestrictions);
        if (liq_esSalarioIntegralSi) liq_esSalarioIntegralSi.addEventListener('change', applyLiquidacionFieldRestrictions);
        if (liq_esSalarioIntegralNo) liq_esSalarioIntegralNo.addEventListener('change', applyLiquidacionFieldRestrictions);
        if (liq_aplicaAuxTransporteSi) liq_aplicaAuxTransporteSi.addEventListener('change', applyLiquidacionFieldRestrictions);
        if (liq_aplicaAuxTransporteNo) liq_aplicaAuxTransporteNo.addEventListener('change', applyLiquidacionFieldRestrictions);
        
        if (mostrarImprimirReciboLiquidacionBtn) mostrarImprimirReciboLiquidacionBtn.addEventListener('click', mostrarReciboLiquidacionParaImprimir);
        if (imprimirLiquidacionDetalladaBtn) imprimirLiquidacionDetalladaBtn.addEventListener('click', printLiquidacionDetallada);
        if (volverAResultadosLiquidacionBtn) volverAResultadosLiquidacionBtn.addEventListener('click', volverAResultadosLiquidacion);
        if (imprimirReciboLiquidacionFinalBtn) imprimirReciboLiquidacionFinalBtn.addEventListener('click', printReciboLiquidacion);

        if (liq_salarioYaPagadoCheck) liq_salarioYaPagadoCheck.addEventListener('change', calcularLiquidacion);

        // Inputs que disparan el cálculo de liquidación al cambiar
        const liqInputs = [
            document.getElementById('liq_fechaIngreso'),
            document.getElementById('liq_fechaRetiro'),
            document.getElementById('liq_salarioBase'),
            document.getElementById('liq_diasVacacionesPendientes'),
            document.getElementById('liq_diasIncapacidad'),
            document.getElementById('liq_diasLicenciaNoRemunerada'),
            document.getElementById('liq_prestamosEmpresa'),
            document.getElementById('liq_aportesVoluntariosPension'),
            document.getElementById('liq_cesantiasConsignadas'),
            document.getElementById('liq_interesesCesantiasPagados'),
            document.getElementById('liq_primasPagadas')
        ];
        liqInputs.forEach(input => {
            if (input) input.addEventListener('change', calcularLiquidacion);
            if (input) input.addEventListener('input', calcularLiquidacion); // For number inputs
        });


        // Initial setup for all tabs
        showTab('nomina'); // Start with the Nomina tab active
    });
    </script>
</body>
</html>
